<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title id="head-title">Integration-report.html</title>
      <link href="assets\style.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <h1 id="title">Integration-report.html</h1>
    <p>Report generated on 01-Mar-2025 at 03:08:03 by <a href="https://pypi.python.org/pypi/pytest-html">pytest-html</a>
        v4.1.1</p>
    <div id="environment-header">
      <h2>Environment</h2>
    </div>
    <table id="environment"></table>
    <!-- TEMPLATES -->
      <template id="template_environment_row">
      <tr>
        <td></td>
        <td></td>
      </tr>
    </template>
    <template id="template_results-table__body--empty">
      <tbody class="results-table-row">
        <tr id="not-found-message">
          <td colspan="4">No results found. Check the filters.</th>
        </tr>
    </template>
    <template id="template_results-table__tbody">
      <tbody class="results-table-row">
        <tr class="collapsible">
        </tr>
        <tr class="extras-row">
          <td class="extra" colspan="4">
            <div class="extraHTML"></div>
            <div class="media">
              <div class="media-container">
                  <div class="media-container__nav--left"><</div>
                  <div class="media-container__viewport">
                    <img src="" />
                    <video controls>
                      <source src="" type="video/mp4">
                    </video>
                  </div>
                  <div class="media-container__nav--right">></div>
                </div>
                <div class="media__name"></div>
                <div class="media__counter"></div>
            </div>
            <div class="logwrapper">
              <div class="logexpander"></div>
              <div class="log"></div>
            </div>
          </td>
        </tr>
      </tbody>
    </template>
    <!-- END TEMPLATES -->
    <div class="summary">
      <div class="summary__data">
        <h2>Summary</h2>
        <div class="additional-summary prefix">
        </div>
        <p class="run-count">28 tests took 00:00:09.</p>
        <p class="filter">(Un)check the boxes to filter the results.</p>
        <div class="summary__reload">
          <div class="summary__reload__button hidden" onclick="location.reload()">
            <div>There are still tests running. <br />Reload this page to get the latest results!</div>
          </div>
        </div>
        <div class="summary__spacer"></div>
        <div class="controls">
          <div class="filters">
            <input checked="true" class="filter" name="filter_checkbox" type="checkbox" data-test-result="failed" disabled/>
            <span class="failed">0 Failed,</span>
            <input checked="true" class="filter" name="filter_checkbox" type="checkbox" data-test-result="passed" />
            <span class="passed">28 Passed,</span>
            <input checked="true" class="filter" name="filter_checkbox" type="checkbox" data-test-result="skipped" />
            <span class="skipped">1 Skipped,</span>
            <input checked="true" class="filter" name="filter_checkbox" type="checkbox" data-test-result="xfailed" disabled/>
            <span class="xfailed">0 Expected failures,</span>
            <input checked="true" class="filter" name="filter_checkbox" type="checkbox" data-test-result="xpassed" disabled/>
            <span class="xpassed">0 Unexpected passes,</span>
            <input checked="true" class="filter" name="filter_checkbox" type="checkbox" data-test-result="error" disabled/>
            <span class="error">0 Errors,</span>
            <input checked="true" class="filter" name="filter_checkbox" type="checkbox" data-test-result="rerun" disabled/>
            <span class="rerun">0 Reruns</span>
          </div>
          <div class="collapse">
            <button id="show_all_details">Show all details</button>&nbsp;/&nbsp;<button id="hide_all_details">Hide all details</button>
          </div>
        </div>
      </div>
      <div class="additional-summary summary">
      </div>
      <div class="additional-summary postfix">
      </div>
    </div>
    <table id="results-table">
      <thead id="results-table-head">
        <tr>
          <th class="sortable" data-column-type="result">Result</th>
          <th class="sortable" data-column-type="testId">Test</th>
          <th class="sortable" data-column-type="duration">Duration</th>
          <th>Links</th>
        </tr>
      </thead>
    </table>
  </body>
  <footer>
    <div id="data-container" data-jsonblob="{&#34;environment&#34;: {&#34;Python&#34;: &#34;3.11.4&#34;, &#34;Platform&#34;: &#34;Windows-10-10.0.22631-SP0&#34;, &#34;Packages&#34;: {&#34;pytest&#34;: &#34;7.4.4&#34;, &#34;pluggy&#34;: &#34;1.5.0&#34;}, &#34;Plugins&#34;: {&#34;anchorpy&#34;: &#34;0.18.0&#34;, &#34;anyio&#34;: &#34;3.7.1&#34;, &#34;Faker&#34;: &#34;22.5.1&#34;, &#34;asyncio&#34;: &#34;0.21.1&#34;, &#34;cov&#34;: &#34;4.1.0&#34;, &#34;html&#34;: &#34;4.1.1&#34;, &#34;metadata&#34;: &#34;3.1.1&#34;, &#34;mock&#34;: &#34;3.12.0&#34;, &#34;timeout&#34;: &#34;2.3.1&#34;, &#34;xdist&#34;: &#34;3.6.1&#34;, &#34;xprocess&#34;: &#34;0.18.1&#34;, &#34;time-machine&#34;: &#34;2.16.0&#34;}}, &#34;tests&#34;: {&#34;backend_tests/integration/test_api/test_auth_api.py::test_register_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_auth_api.py::test_register_api&#34;, &#34;duration&#34;: &#34;00:00:01&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_auth_api.py::test_register_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;00:00:01&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\n2025-03-01 03:07:55,187 - core.api.v1.auth.router - DEBUG - Register request data: email=&amp;#x27;test_register_1740769675@example.com&amp;#x27; password=&amp;#x27;TestPassword123!&amp;#x27; name=&amp;#x27;Test User&amp;#x27;\n2025-03-01 03:07:56,010 - core.api.v1.auth.router - DEBUG - Register request data: email=&amp;#x27;test_register_1740769675@example.com&amp;#x27; password=&amp;#x27;TestPassword123!&amp;#x27; name=&amp;#x27;Another User&amp;#x27;\n2025-03-01 03:07:56,015 - core.api.v1.auth.router - ERROR - Registration failed: Email already registered\n2025-03-01 03:07:56,015 - core.api.v1.auth.router - ERROR - Error details: {&amp;#x27;email&amp;#x27;: &amp;#x27;test_register_1740769675@example.com&amp;#x27;}\n\n----------------------------- Captured stderr call -----------------------------\nDEBUG:core.api.v1.auth.router:Register request data: email=&amp;#x27;test_register_1740769675@example.com&amp;#x27; password=&amp;#x27;TestPassword123!&amp;#x27; name=&amp;#x27;Test User&amp;#x27;\nsys:1: SAWarning: relationship &amp;#x27;Deal.tracked_by_users&amp;#x27; will copy column deals.id to column tracked_deals.deal_id, which conflicts with relationship(s): &amp;#x27;Deal.trackers&amp;#x27; (copies deals.id to tracked_deals.deal_id). If this is not the intention, consider if these relationships should be linked with back_populates, or if viewonly=True should be applied to one or more if they are read-only. For the less common case that foreign key constraints are partially overlapping, the orm.foreign() annotation can be used to isolate the columns that should be written towards.   To silence this warning, add the parameter &amp;#x27;overlaps=&amp;quot;trackers&amp;quot;&amp;#x27; to the &amp;#x27;Deal.tracked_by_users&amp;#x27; relationship. (Background on this warning at: https://sqlalche.me/e/20/qzyx) (This warning originated from the `configure_mappers()` process, which was invoked automatically in response to a user-initiated operation.)\nWARNING:passlib.handlers.bcrypt:(trapped) error reading bcrypt version\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages\\passlib\\handlers\\bcrypt.py&amp;quot;, line 620, in _load_backend_mixin\n    version = _bcrypt.__about__.__version__\n              ^^^^^^^^^^^^^^^^^\nAttributeError: module &amp;#x27;bcrypt&amp;#x27; has no attribute &amp;#x27;__about__&amp;#x27;\nINFO:core.services.auth:User registered successfully: test_register_1740769675@example.com\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/register &amp;quot;HTTP/1.1 201 Created&amp;quot;\nDEBUG:core.api.v1.auth.router:Register request data: email=&amp;#x27;test_register_1740769675@example.com&amp;#x27; password=&amp;#x27;TestPassword123!&amp;#x27; name=&amp;#x27;Another User&amp;#x27;\nERROR:core.api.v1.auth.router:Registration failed: Email already registered\nERROR:core.api.v1.auth.router:Error details: {&amp;#x27;email&amp;#x27;: &amp;#x27;test_register_1740769675@example.com&amp;#x27;}\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/register &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nDEBUG    core.api.v1.auth.router:router.py:79 Register request data: email=&amp;#x27;test_register_1740769675@example.com&amp;#x27; password=&amp;#x27;TestPassword123!&amp;#x27; name=&amp;#x27;Test User&amp;#x27;\nWARNING  passlib.handlers.bcrypt:bcrypt.py:622 (trapped) error reading bcrypt version\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages\\passlib\\handlers\\bcrypt.py&amp;quot;, line 620, in _load_backend_mixin\n    version = _bcrypt.__about__.__version__\n              ^^^^^^^^^^^^^^^^^\nAttributeError: module &amp;#x27;bcrypt&amp;#x27; has no attribute &amp;#x27;__about__&amp;#x27;\nINFO     core.services.auth:auth.py:779 User registered successfully: test_register_1740769675@example.com\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/register &amp;quot;HTTP/1.1 201 Created&amp;quot;\nDEBUG    core.api.v1.auth.router:router.py:79 Register request data: email=&amp;#x27;test_register_1740769675@example.com&amp;#x27; password=&amp;#x27;TestPassword123!&amp;#x27; name=&amp;#x27;Another User&amp;#x27;\nERROR    core.api.v1.auth.router:router.py:105 Registration failed: Email already registered\nERROR    core.api.v1.auth.router:router.py:107 Error details: {&amp;#x27;email&amp;#x27;: &amp;#x27;test_register_1740769675@example.com&amp;#x27;}\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/register &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_auth_api.py::test_login_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_auth_api.py::test_login_api&#34;, &#34;duration&#34;: &#34;333 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_auth_api.py::test_login_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;333 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\n2025-03-01 03:07:56,343 - core.api.v1.auth.router - ERROR - Unexpected error during login: Invalid email or password\n2025-03-01 03:07:56,343 - core.api.v1.auth.router - WARNING - In test environment - returning 401 instead of 500\n2025-03-01 03:07:56,353 - core.api.v1.auth.router - ERROR - Unexpected error during login: Invalid email or password\n2025-03-01 03:07:56,353 - core.api.v1.auth.router - WARNING - In test environment - returning 401 instead of 500\n\n----------------------------- Captured stderr call -----------------------------\nWARNING:core.services.auth:User not found or inactive: test_login_1740769676@example.com\nERROR:core.api.v1.auth.router:Unexpected error during login: Invalid email or password\nWARNING:core.api.v1.auth.router:In test environment - returning 401 instead of 500\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/login &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\nWARNING:core.services.auth:User not found or inactive: test_login_1740769676@example.com\nERROR:core.api.v1.auth.router:Unexpected error during login: Invalid email or password\nWARNING:core.api.v1.auth.router:In test environment - returning 401 instead of 500\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/login &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nWARNING  core.services.auth:auth.py:968 User not found or inactive: test_login_1740769676@example.com\nERROR    core.api.v1.auth.router:router.py:143 Unexpected error during login: Invalid email or password\nWARNING  core.api.v1.auth.router:router.py:146 In test environment - returning 401 instead of 500\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/login &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\nWARNING  core.services.auth:auth.py:968 User not found or inactive: test_login_1740769676@example.com\nERROR    core.api.v1.auth.router:router.py:143 Unexpected error during login: Invalid email or password\nWARNING  core.api.v1.auth.router:router.py:146 In test environment - returning 401 instead of 500\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/login &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_auth_api.py::test_refresh_token_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_auth_api.py::test_refresh_token_api&#34;, &#34;duration&#34;: &#34;256 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_auth_api.py::test_refresh_token_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;256 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\n2025-03-01 03:07:56,611 - core.api.v1.auth.router - WARNING - Token refresh failed: Could not refresh tokens: User not found: 7f92b3c6-4a01-4387-a074-07194238e8c7\n2025-03-01 03:07:56,614 - core.api.v1.auth.router - WARNING - Token refresh failed: Token error\n\n----------------------------- Captured stderr call -----------------------------\nERROR:core.services.auth:Error getting user by ID: User not found: 7f92b3c6-4a01-4387-a074-07194238e8c7\nERROR:core.services.auth:Token refresh failed: User not found: 7f92b3c6-4a01-4387-a074-07194238e8c7\nWARNING:core.api.v1.auth.router:Token refresh failed: Could not refresh tokens: User not found: 7f92b3c6-4a01-4387-a074-07194238e8c7\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/refresh &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\nWARNING:core.api.v1.auth.router:Token refresh failed: Token error\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/refresh &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.auth:auth.py:935 Error getting user by ID: User not found: 7f92b3c6-4a01-4387-a074-07194238e8c7\nERROR    core.services.auth:auth.py:820 Token refresh failed: User not found: 7f92b3c6-4a01-4387-a074-07194238e8c7\nWARNING  core.api.v1.auth.router:router.py:187 Token refresh failed: Could not refresh tokens: User not found: 7f92b3c6-4a01-4387-a074-07194238e8c7\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/refresh &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\nWARNING  core.api.v1.auth.router:router.py:187 Token refresh failed: Token error\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/refresh &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_auth_api.py::test_logout_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_auth_api.py::test_logout_api&#34;, &#34;duration&#34;: &#34;259 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_auth_api.py::test_logout_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;259 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stderr call -----------------------------\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/logout &amp;quot;HTTP/1.1 200 OK&amp;quot;\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2ZmM0NDllMS1kOTc5LTQ0ZDQtYWJlOS1lMjZjMDk4MGVhZGYiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc2Ljg2NzE3OH0.zY95e89QUzx5kOakmEV1ptk3q7AL-wyT4tpGIwAz5hk: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/logout &amp;quot;HTTP/1.1 200 OK&amp;quot;\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2ZmM0NDllMS1kOTc5LTQ0ZDQtYWJlOS1lMjZjMDk4MGVhZGYiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc2Ljg2NzE3OH0.zY95e89QUzx5kOakmEV1ptk3q7AL-wyT4tpGIwAz5hk: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_auth_api.py::test_password_reset_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_auth_api.py::test_password_reset_api&#34;, &#34;duration&#34;: &#34;252 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_auth_api.py::test_password_reset_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;252 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stderr call -----------------------------\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/reset-password/request?email=test_62c14cb7@example.com &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/reset-password/request?email=test_62c14cb7@example.com &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_auth_api.py::test_protected_api_access&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_auth_api.py::test_protected_api_access&#34;, &#34;duration&#34;: &#34;255 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_auth_api.py::test_protected_api_access&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;255 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stderr call -----------------------------\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzN2RjNjEzZi0yYjZkLTQxN2QtYjM0OC0xZjdmMjMwNGMwYjAiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc3LjM3MjE3NH0.NHnZdhWOlGpueFCI7o7-xr714MQw4IVP69yZT8ww3u8: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 200 OK&amp;quot;\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\nERROR:core.services.redis:Error getting Redis key blacklist:invalid_token: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Error verifying token: Not enough segments\nERROR:core.services.auth:Authentication error: 401: Could not validate credentials\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzN2RjNjEzZi0yYjZkLTQxN2QtYjM0OC0xZjdmMjMwNGMwYjAiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc3LjM3MjE3NH0.NHnZdhWOlGpueFCI7o7-xr714MQw4IVP69yZT8ww3u8: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 200 OK&amp;quot;\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:invalid_token: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:391 Error verifying token: Not enough segments\nERROR    core.services.auth:auth.py:422 Authentication error: 401: Could not validate credentials\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_auth_endpoints.py::test_login_endpoint&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_auth_endpoints.py::test_login_endpoint&#34;, &#34;duration&#34;: &#34;252 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_auth_endpoints.py::test_login_endpoint&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;252 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient async POST: /api/v1/auth/login\nAPITestClient async POST: /api/v1/auth/login\n\n----------------------------- Captured stderr call -----------------------------\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/login &amp;quot;HTTP/1.1 422 Unprocessable Entity&amp;quot;\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/login &amp;quot;HTTP/1.1 422 Unprocessable Entity&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/login &amp;quot;HTTP/1.1 422 Unprocessable Entity&amp;quot;\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/login &amp;quot;HTTP/1.1 422 Unprocessable Entity&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_auth_endpoints.py::test_protected_endpoint&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_auth_endpoints.py::test_protected_endpoint&#34;, &#34;duration&#34;: &#34;12 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_auth_endpoints.py::test_protected_endpoint&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;12 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stderr call -----------------------------\nERROR:core.services.auth:Error verifying token: Not enough segments\nERROR:core.services.auth:Authentication error: 401: Could not validate credentials\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 200 OK&amp;quot;\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.auth:auth.py:391 Error verifying token: Not enough segments\nERROR    core.services.auth:auth.py:422 Authentication error: 401: Could not validate credentials\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 200 OK&amp;quot;\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/users/me &amp;quot;HTTP/1.1 401 Unauthorized&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_auth_endpoints.py::test_logout_endpoint&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_auth_endpoints.py::test_logout_endpoint&#34;, &#34;duration&#34;: &#34;5 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_auth_endpoints.py::test_logout_endpoint&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;5 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stderr call -----------------------------\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/auth/logout &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/auth/logout &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_deal_api.py::test_create_deal_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_deal_api.py::test_create_deal_api&#34;, &#34;duration&#34;: &#34;332 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_deal_api.py::test_create_deal_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;332 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient POST: /api/v1/deals\nDeal creation response status code: 201\nDeal creation response content: b&amp;#x27;{&amp;quot;title&amp;quot;:&amp;quot;Test Deal&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;Test Description&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;https://test.com/deal&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;99.99&amp;quot;,&amp;quot;original_price&amp;quot;:&amp;quot;149.99&amp;quot;,&amp;quot;currency&amp;quot;:&amp;quot;USD&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test_source&amp;quot;,&amp;quot;image_url&amp;quot;:&amp;quot;https://test.com/image.jpg&amp;quot;,&amp;quot;deal_metadata&amp;quot;:null,&amp;quot;price_metadata&amp;quot;:null,&amp;quot;expires_at&amp;quot;:null,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;b8d75e45-3b66-4d93-8034-93637920da57&amp;quot;,&amp;quot;goal_id&amp;quot;:&amp;quot;22c5dc0e-9566-4219-9d4f-45e38cd7bab1&amp;quot;,&amp;quot;market_id&amp;quot;:&amp;quot;48d34faa-cf2a-43e5-9f85-e1468bdd5f02&amp;quot;,&amp;quot;found_at&amp;quot;:&amp;quot;2025-02-28T19:07:57.994739&amp;quot;,&amp;quot;category&amp;quot;:&amp;quot;electronics&amp;quot;,&amp;quot;seller_info&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;Test Seller&amp;quot;,&amp;quot;rating&amp;quot;:4.5},&amp;quot;availability&amp;quot;:{&amp;quot;in_stock&amp;quot;:true,&amp;quot;quantity&amp;quot;:10},&amp;quot;latest_score&amp;quot;:85.0,&amp;quot;price_history&amp;quot;:[{&amp;quot;price&amp;quot;:&amp;quot;109.99&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-21T19:07:57.994739&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;historical&amp;quot;},{&amp;quot;price&amp;quot;:&amp;quot;99.99&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-28T19:07:57.994739&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;current&amp;quot;}],&amp;quot;market_analysis&amp;quot;:null,&amp;quot;deal_score&amp;quot;:null,&amp;quot;created_at&amp;quot;:&amp;quot;2025-02-28T19:07:57.994739&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-02-28T19:07:57.994739&amp;quot;}&amp;#x27;\n\n----------------------------- Captured stderr call -----------------------------\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/deals &amp;quot;HTTP/1.1 201 Created&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/deals &amp;quot;HTTP/1.1 201 Created&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_deal_api.py::test_deal_price_history_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_deal_api.py::test_deal_price_history_api&#34;, &#34;duration&#34;: &#34;47 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_deal_api.py::test_deal_price_history_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;47 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient POST: /api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/prices\nPrice point addition response status code: 404\nPrice point addition response content: b&amp;#x27;{&amp;quot;detail&amp;quot;:&amp;quot;Not Found&amp;quot;}&amp;#x27;\nAPITestClient POST: /api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/prices\nPrice point addition response status code: 404\nPrice point addition response content: b&amp;#x27;{&amp;quot;detail&amp;quot;:&amp;quot;Not Found&amp;quot;}&amp;#x27;\nAPITestClient POST: /api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/prices\nPrice point addition response status code: 404\nPrice point addition response content: b&amp;#x27;{&amp;quot;detail&amp;quot;:&amp;quot;Not Found&amp;quot;}&amp;#x27;\nAPITestClient GET: /api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/price-history\nPrice history retrieval response status code: 200\nPrice history retrieval response content: b&amp;#x27;{&amp;quot;deal_id&amp;quot;:&amp;quot;c48959ff-9b8d-47c1-a690-401c112920bb&amp;quot;,&amp;quot;prices&amp;quot;:[{&amp;quot;id&amp;quot;:&amp;quot;a483a9be-4e8a-48eb-827a-e86fa754427d&amp;quot;,&amp;quot;deal_id&amp;quot;:&amp;quot;c48959ff-9b8d-47c1-a690-401c112920bb&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;100.0&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test&amp;quot;,&amp;quot;created_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.016428Z&amp;quot;},{&amp;quot;id&amp;quot;:&amp;quot;4f1e72e0-d760-446b-994a-fa25cbbb07e7&amp;quot;,&amp;quot;deal_id&amp;quot;:&amp;quot;c48959ff-9b8d-47c1-a690-401c112920bb&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;95.0&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test&amp;quot;,&amp;quot;created_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.016428Z&amp;quot;},{&amp;quot;id&amp;quot;:&amp;quot;dd67c108-5acf-4fa2-9aa8-27b46112c0f8&amp;quot;,&amp;quot;deal_id&amp;quot;:&amp;quot;c48959ff-9b8d-47c1-a690-401c112920bb&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;90.0&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test&amp;quot;,&amp;quot;created_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.016428Z&amp;quot;}],&amp;quot;trend&amp;quot;:&amp;quot;decreasing&amp;quot;,&amp;quot;average_price&amp;quot;:&amp;quot;95.0&amp;quot;,&amp;quot;lowest_price&amp;quot;:&amp;quot;90.0&amp;quot;,&amp;quot;highest_price&amp;quot;:&amp;quot;100.0&amp;quot;,&amp;quot;start_date&amp;quot;:&amp;quot;2025-01-30T03:07:58.016428Z&amp;quot;,&amp;quot;end_date&amp;quot;:&amp;quot;2025-03-01T03:07:58.016428Z&amp;quot;}&amp;#x27;\n\n----------------------------- Captured stderr call -----------------------------\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/price-history &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/deals/c48959ff-9b8d-47c1-a690-401c112920bb/price-history &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_deal_api.py::test_list_deals_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_deal_api.py::test_list_deals_api&#34;, &#34;duration&#34;: &#34;41 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_deal_api.py::test_list_deals_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;41 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient GET: /api/v1/deals\nDeal listing response status code: 200\nDeal listing response content: b&amp;#x27;[{&amp;quot;title&amp;quot;:&amp;quot;Test Deal 0&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;Test Description 0&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;https://test.com/deal0&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;50.99&amp;quot;,&amp;quot;original_price&amp;quot;:&amp;quot;99.99&amp;quot;,&amp;quot;currency&amp;quot;:&amp;quot;USD&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test_source&amp;quot;,&amp;quot;image_url&amp;quot;:&amp;quot;https://test.com/image0.jpg&amp;quot;,&amp;quot;deal_metadata&amp;quot;:null,&amp;quot;price_metadata&amp;quot;:null,&amp;quot;expires_at&amp;quot;:null,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;0d1521b4-48a7-4b52-996f-b0a5cfb35dd6&amp;quot;,&amp;quot;goal_id&amp;quot;:&amp;quot;00000000-0000-0000-0000-000000000000&amp;quot;,&amp;quot;market_id&amp;quot;:&amp;quot;d5c622fe-ec1d-4918-aabd-bc4f2bab9d31&amp;quot;,&amp;quot;found_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.089196&amp;quot;,&amp;quot;category&amp;quot;:&amp;quot;electronics&amp;quot;,&amp;quot;seller_info&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;Test Seller&amp;quot;,&amp;quot;rating&amp;quot;:4.5},&amp;quot;availability&amp;quot;:{&amp;quot;in_stock&amp;quot;:true,&amp;quot;quantity&amp;quot;:10},&amp;quot;latest_score&amp;quot;:85.0,&amp;quot;price_history&amp;quot;:[{&amp;quot;price&amp;quot;:&amp;quot;56.089&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-21T19:07:58.089196&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;historical&amp;quot;},{&amp;quot;price&amp;quot;:&amp;quot;50.99&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-28T19:07:58.089196&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;current&amp;quot;}],&amp;quot;market_analysis&amp;quot;:null,&amp;quot;deal_score&amp;quot;:null,&amp;quot;created_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.058060+00:00&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.058060+00:00&amp;quot;},{&amp;quot;title&amp;quot;:&amp;quot;Test Deal 1&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;Test Description 1&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;https://test.com/deal1&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;60.99&amp;quot;,&amp;quot;original_price&amp;quot;:&amp;quot;109.99&amp;quot;,&amp;quot;currency&amp;quot;:&amp;quot;USD&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test_source&amp;quot;,&amp;quot;image_url&amp;quot;:&amp;quot;https://test.com/image1.jpg&amp;quot;,&amp;quot;deal_metadata&amp;quot;:null,&amp;quot;price_metadata&amp;quot;:null,&amp;quot;expires_at&amp;quot;:null,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;8cf0c469-81e9-4b15-a75c-e9b7509cfa0f&amp;quot;,&amp;quot;goal_id&amp;quot;:&amp;quot;00000000-0000-0000-0000-000000000000&amp;quot;,&amp;quot;market_id&amp;quot;:&amp;quot;464d6055-cb9c-437d-b231-73d4a7ea92cb&amp;quot;,&amp;quot;found_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.089196&amp;quot;,&amp;quot;category&amp;quot;:&amp;quot;electronics&amp;quot;,&amp;quot;seller_info&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;Test Seller&amp;quot;,&amp;quot;rating&amp;quot;:4.5},&amp;quot;availability&amp;quot;:{&amp;quot;in_stock&amp;quot;:true,&amp;quot;quantity&amp;quot;:10},&amp;quot;latest_score&amp;quot;:85.0,&amp;quot;price_history&amp;quot;:[{&amp;quot;price&amp;quot;:&amp;quot;67.089&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-21T19:07:58.089196&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;historical&amp;quot;},{&amp;quot;price&amp;quot;:&amp;quot;60.99&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-28T19:07:58.089196&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;current&amp;quot;}],&amp;quot;market_analysis&amp;quot;:null,&amp;quot;deal_score&amp;quot;:null,&amp;quot;created_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.058060+00:00&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.058060+00:00&amp;quot;},{&amp;quot;title&amp;quot;:&amp;quot;Test Deal 2&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;Test Description 2&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;https://test.com/deal2&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;70.99000000000001&amp;quot;,&amp;quot;original_price&amp;quot;:&amp;quot;119.99&amp;quot;,&amp;quot;currency&amp;quot;:&amp;quot;USD&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test_source&amp;quot;,&amp;quot;image_url&amp;quot;:&amp;quot;https://test.com/image2.jpg&amp;quot;,&amp;quot;deal_metadata&amp;quot;:null,&amp;quot;price_metadata&amp;quot;:null,&amp;quot;expires_at&amp;quot;:null,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;b9a4dfd8-97d2-4a32-88ee-5437bb027858&amp;quot;,&amp;quot;goal_id&amp;quot;:&amp;quot;00000000-0000-0000-0000-000000000000&amp;quot;,&amp;quot;market_id&amp;quot;:&amp;quot;34cd75f2-e20d-4dc5-adb3-5628fa01f996&amp;quot;,&amp;quot;found_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.089196&amp;quot;,&amp;quot;category&amp;quot;:&amp;quot;electronics&amp;quot;,&amp;quot;seller_info&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;Test Seller&amp;quot;,&amp;quot;rating&amp;quot;:4.5},&amp;quot;availability&amp;quot;:{&amp;quot;in_stock&amp;quot;:true,&amp;quot;quantity&amp;quot;:10},&amp;quot;latest_score&amp;quot;:85.0,&amp;quot;price_history&amp;quot;:[{&amp;quot;price&amp;quot;:&amp;quot;78.089000000000011&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-21T19:07:58.089196&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;historical&amp;quot;},{&amp;quot;price&amp;quot;:&amp;quot;70.99000000000001&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-28T19:07:58.089196&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;current&amp;quot;}],&amp;quot;market_analysis&amp;quot;:null,&amp;quot;deal_score&amp;quot;:null,&amp;quot;created_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.058060+00:00&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.058060+00:00&amp;quot;}]&amp;#x27;\n\n----------------------------- Captured stderr call -----------------------------\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/deals &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/deals &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_deal_api.py::test_validate_deal_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_deal_api.py::test_validate_deal_api&#34;, &#34;duration&#34;: &#34;201 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_deal_api.py::test_validate_deal_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;201 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient POST: /api/v1/deals/7b38736e-239e-4ebe-8587-bb1b02ac5254/validate\n2025-03-01 03:07:58,150 - core.repositories.token - DEBUG - Looking for pricing for service_type=deal_validation, current time=2025-02-28 19:07:58.150776+00:00\n2025-03-01 03:07:58,271 - core.repositories.token - DEBUG - Found 1 pricing records for service_type=deal_validation\n2025-03-01 03:07:58,272 - core.repositories.token - DEBUG - Record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, service_type=deal_validation, is_active=True, valid_from=2025-02-28 04:43:04.325342+00:00, valid_to=None\n2025-03-01 03:07:58,277 - core.repositories.token - DEBUG - Found active pricing record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, cost=1.00000000\n2025-03-01 03:07:58,277 - core.services.token - DEBUG - Retrieved pricing info for service deal_validation\n2025-03-01 03:07:58,284 - core.services.token - DEBUG - Retrieved balance for user 00000000-0000-4000-a000-000000000000: None\n2025-03-01 03:07:58,285 - core.repositories.token - DEBUG - Looking for pricing for service_type=deal_validation, current time=2025-02-28 19:07:58.285512+00:00\n2025-03-01 03:07:58,287 - core.repositories.token - DEBUG - Found 1 pricing records for service_type=deal_validation\n2025-03-01 03:07:58,287 - core.repositories.token - DEBUG - Record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, service_type=deal_validation, is_active=True, valid_from=2025-02-28 04:43:04.325342+00:00, valid_to=None\n2025-03-01 03:07:58,289 - core.repositories.token - DEBUG - Found active pricing record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, cost=1.00000000\n2025-03-01 03:07:58,289 - core.services.token - DEBUG - Retrieved pricing info for service deal_validation\n2025-03-01 03:07:58,292 - core.services.token - ERROR - Failed to deduct tokens for user 00000000-0000-4000-a000-000000000000: Insufficient balance for deduction\n2025-03-01 03:07:58,293 - core.services.token - ERROR - Failed to deduct tokens for operation deal_validation: Token transaction error deduct_tokens during deduct_tokens: Failed to deduct tokens: Insufficient balance for deduction\nDeal validation response status code: 200\nDeal validation response content: b&amp;#x27;{&amp;quot;is_valid&amp;quot;:true,&amp;quot;validation_details&amp;quot;:{&amp;quot;url_check&amp;quot;:&amp;quot;passed&amp;quot;,&amp;quot;price_check&amp;quot;:&amp;quot;passed&amp;quot;,&amp;quot;availability_check&amp;quot;:&amp;quot;passed&amp;quot;}}&amp;#x27;\n\n----------------------------- Captured stderr call -----------------------------\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nDEBUG:core.repositories.token:Looking for pricing for service_type=deal_validation, current time=2025-02-28 19:07:58.150776+00:00\nDEBUG:core.repositories.token:Found 1 pricing records for service_type=deal_validation\nDEBUG:core.repositories.token:Record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, service_type=deal_validation, is_active=True, valid_from=2025-02-28 04:43:04.325342+00:00, valid_to=None\nDEBUG:core.repositories.token:Found active pricing record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, cost=1.00000000\nDEBUG:core.services.token:Retrieved pricing info for service deal_validation\nDEBUG:core.services.token:Retrieved balance for user 00000000-0000-4000-a000-000000000000: None\nDEBUG:core.repositories.token:Looking for pricing for service_type=deal_validation, current time=2025-02-28 19:07:58.285512+00:00\nDEBUG:core.repositories.token:Found 1 pricing records for service_type=deal_validation\nDEBUG:core.repositories.token:Record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, service_type=deal_validation, is_active=True, valid_from=2025-02-28 04:43:04.325342+00:00, valid_to=None\nDEBUG:core.repositories.token:Found active pricing record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, cost=1.00000000\nDEBUG:core.services.token:Retrieved pricing info for service deal_validation\nERROR:core.services.token:Failed to deduct tokens for user 00000000-0000-4000-a000-000000000000: Insufficient balance for deduction\nERROR:core.services.token:Failed to deduct tokens for operation deal_validation: Token transaction error deduct_tokens during deduct_tokens: Failed to deduct tokens: Insufficient balance for deduction\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/deals/7b38736e-239e-4ebe-8587-bb1b02ac5254/validate &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nDEBUG    core.repositories.token:token.py:814 Looking for pricing for service_type=deal_validation, current time=2025-02-28 19:07:58.150776+00:00\nDEBUG    core.repositories.token:token.py:825 Found 1 pricing records for service_type=deal_validation\nDEBUG    core.repositories.token:token.py:827 Record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, service_type=deal_validation, is_active=True, valid_from=2025-02-28 04:43:04.325342+00:00, valid_to=None\nDEBUG    core.repositories.token:token.py:846 Found active pricing record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, cost=1.00000000\nDEBUG    core.services.token:token.py:228 Retrieved pricing info for service deal_validation\nDEBUG    core.services.token:token.py:156 Retrieved balance for user 00000000-0000-4000-a000-000000000000: None\nDEBUG    core.repositories.token:token.py:814 Looking for pricing for service_type=deal_validation, current time=2025-02-28 19:07:58.285512+00:00\nDEBUG    core.repositories.token:token.py:825 Found 1 pricing records for service_type=deal_validation\nDEBUG    core.repositories.token:token.py:827 Record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, service_type=deal_validation, is_active=True, valid_from=2025-02-28 04:43:04.325342+00:00, valid_to=None\nDEBUG    core.repositories.token:token.py:846 Found active pricing record: id=d209f1aa-f496-445c-b0d3-876b4c99dc22, cost=1.00000000\nDEBUG    core.services.token:token.py:228 Retrieved pricing info for service deal_validation\nERROR    core.services.token:token.py:261 Failed to deduct tokens for user 00000000-0000-4000-a000-000000000000: Insufficient balance for deduction\nERROR    core.services.token:token.py:314 Failed to deduct tokens for operation deal_validation: Token transaction error deduct_tokens during deduct_tokens: Failed to deduct tokens: Insufficient balance for deduction\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/deals/7b38736e-239e-4ebe-8587-bb1b02ac5254/validate &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_deal_api.py::test_refresh_deal_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_deal_api.py::test_refresh_deal_api&#34;, &#34;duration&#34;: &#34;96 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_deal_api.py::test_refresh_deal_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;96 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient POST: /api/v1/deals/6295369e-a142-4037-826e-d881135b9105/refresh\n2025-03-01 03:07:58,386 - core.repositories.token - DEBUG - Looking for pricing for service_type=deal_refresh, current time=2025-02-28 19:07:58.386022+00:00\n2025-03-01 03:07:58,391 - core.repositories.token - DEBUG - No pricing records found for service_type=deal_refresh\n2025-03-01 03:07:58,391 - core.services.token - DEBUG - Retrieved pricing info for service deal_refresh\n2025-03-01 03:07:58,391 - core.services.token - WARNING - No pricing found for operation deal_refresh\n2025-03-01 03:07:58,393 - core.repositories.token - DEBUG - Looking for pricing for service_type=deal_refresh, current time=2025-02-28 19:07:58.393709+00:00\n2025-03-01 03:07:58,394 - core.repositories.token - DEBUG - No pricing records found for service_type=deal_refresh\n2025-03-01 03:07:58,394 - core.services.token - DEBUG - Retrieved pricing info for service deal_refresh\n2025-03-01 03:07:58,394 - core.services.token - WARNING - No pricing found for operation deal_refresh, skipping token deduction\nDeal refresh response status code: 200\nDeal refresh response content: b&amp;#x27;{&amp;quot;title&amp;quot;:&amp;quot;Test Deal&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;Test Description&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;https://test.com/deal&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;100.00&amp;quot;,&amp;quot;original_price&amp;quot;:&amp;quot;149.99&amp;quot;,&amp;quot;currency&amp;quot;:&amp;quot;USD&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test_source&amp;quot;,&amp;quot;image_url&amp;quot;:&amp;quot;https://test.com/image.jpg&amp;quot;,&amp;quot;deal_metadata&amp;quot;:null,&amp;quot;price_metadata&amp;quot;:null,&amp;quot;expires_at&amp;quot;:null,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;6295369e-a142-4037-826e-d881135b9105&amp;quot;,&amp;quot;goal_id&amp;quot;:&amp;quot;00000000-0000-0000-0000-000000000000&amp;quot;,&amp;quot;market_id&amp;quot;:&amp;quot;a1c79aa0-1db0-474b-862b-45be7c2b2179&amp;quot;,&amp;quot;found_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.392583&amp;quot;,&amp;quot;category&amp;quot;:&amp;quot;electronics&amp;quot;,&amp;quot;seller_info&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;Test Seller&amp;quot;,&amp;quot;rating&amp;quot;:4.5},&amp;quot;availability&amp;quot;:{&amp;quot;in_stock&amp;quot;:true,&amp;quot;quantity&amp;quot;:10},&amp;quot;latest_score&amp;quot;:85.0,&amp;quot;price_history&amp;quot;:[{&amp;quot;price&amp;quot;:&amp;quot;110.000&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-21T19:07:58.392583&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;historical&amp;quot;},{&amp;quot;price&amp;quot;:&amp;quot;100.00&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-28T19:07:58.392583&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;refresh&amp;quot;}],&amp;quot;market_analysis&amp;quot;:null,&amp;quot;deal_score&amp;quot;:null,&amp;quot;created_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.307056+00:00&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-03-01T03:07:58.307056+00:00&amp;quot;}&amp;#x27;\n\n----------------------------- Captured stderr call -----------------------------\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nDEBUG:core.repositories.token:Looking for pricing for service_type=deal_refresh, current time=2025-02-28 19:07:58.386022+00:00\nDEBUG:core.repositories.token:No pricing records found for service_type=deal_refresh\nDEBUG:core.services.token:Retrieved pricing info for service deal_refresh\nWARNING:core.services.token:No pricing found for operation deal_refresh\nDEBUG:core.repositories.token:Looking for pricing for service_type=deal_refresh, current time=2025-02-28 19:07:58.393709+00:00\nDEBUG:core.repositories.token:No pricing records found for service_type=deal_refresh\nDEBUG:core.services.token:Retrieved pricing info for service deal_refresh\nWARNING:core.services.token:No pricing found for operation deal_refresh, skipping token deduction\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/deals/6295369e-a142-4037-826e-d881135b9105/refresh &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nDEBUG    core.repositories.token:token.py:814 Looking for pricing for service_type=deal_refresh, current time=2025-02-28 19:07:58.386022+00:00\nDEBUG    core.repositories.token:token.py:822 No pricing records found for service_type=deal_refresh\nDEBUG    core.services.token:token.py:228 Retrieved pricing info for service deal_refresh\nWARNING  core.services.token:token.py:403 No pricing found for operation deal_refresh\nDEBUG    core.repositories.token:token.py:814 Looking for pricing for service_type=deal_refresh, current time=2025-02-28 19:07:58.393709+00:00\nDEBUG    core.repositories.token:token.py:822 No pricing records found for service_type=deal_refresh\nDEBUG    core.services.token:token.py:228 Retrieved pricing info for service deal_refresh\nWARNING  core.services.token:token.py:293 No pricing found for operation deal_refresh, skipping token deduction\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/deals/6295369e-a142-4037-826e-d881135b9105/refresh &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_deal_api.py::test_deal_goals_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_deal_api.py::test_deal_goals_api&#34;, &#34;duration&#34;: &#34;32 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_deal_api.py::test_deal_goals_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;32 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient GET: /api/v1/deals/f0b50ac5-369a-4411-a8cb-5b240ad073ba/goals\nDeal goals matching response status code: 200\nDeal goals matching response content: b&amp;#x27;[{&amp;quot;id&amp;quot;:&amp;quot;30293bee-263a-4b4f-928e-e0c0b7adadc1&amp;quot;,&amp;quot;title&amp;quot;:&amp;quot;Test Goal 0&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;Test Description 0&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;user_id&amp;quot;:&amp;quot;00000000-0000-4000-a000-000000000000&amp;quot;,&amp;quot;created_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.431214&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.431214&amp;quot;},{&amp;quot;id&amp;quot;:&amp;quot;fbbf9395-a0c4-4e35-b255-a77109919043&amp;quot;,&amp;quot;title&amp;quot;:&amp;quot;Test Goal 1&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;Test Description 1&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;user_id&amp;quot;:&amp;quot;00000000-0000-4000-a000-000000000000&amp;quot;,&amp;quot;created_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.431214&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.431214&amp;quot;},{&amp;quot;id&amp;quot;:&amp;quot;3c22baa3-a33b-4816-88c0-47d4a17af11e&amp;quot;,&amp;quot;title&amp;quot;:&amp;quot;Test Goal 2&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;Test Description 2&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;user_id&amp;quot;:&amp;quot;00000000-0000-4000-a000-000000000000&amp;quot;,&amp;quot;created_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.431214&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-02-28T19:07:58.431214&amp;quot;}]&amp;#x27;\n\n----------------------------- Captured stderr call -----------------------------\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/deals/f0b50ac5-369a-4411-a8cb-5b240ad073ba/goals &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ7dXNlcl9pZH0iLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzE2NDE5LjQyODc5OH0.dSSq7oK6aNgZQgEnAiIsJ2IHDZRFppP-1LyPRc2U-qY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/deals/f0b50ac5-369a-4411-a8cb-5b240ad073ba/goals &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_goal_api.py::test_create_goal_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_goal_api.py::test_create_goal_api&#34;, &#34;duration&#34;: &#34;293 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_goal_api.py::test_create_goal_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;293 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;No log output captured.&#34;}], &#34;backend_tests/integration/test_api/test_goal_api.py::test_list_goals_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_goal_api.py::test_list_goals_api&#34;, &#34;duration&#34;: &#34;301 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_goal_api.py::test_list_goals_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;301 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient async GET: /api/v1/goals/\nAPITestClient async GET: /api/v1/goals/\n\n----------------------------- Captured stderr call -----------------------------\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI3NmU0ZGRmNS0wNDI4LTRhNDUtOGQ1OC1mNDVlNTdkZmFmOTMiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc4Ljk4MTMxM30.QS7ZCkKxe7Y4hvTPOA1BmROxd8Ai-aT3FAhQ4HREmUI: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/goals/ &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI3NmU0ZGRmNS0wNDI4LTRhNDUtOGQ1OC1mNDVlNTdkZmFmOTMiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc4Ljk4MTMxM30.QS7ZCkKxe7Y4hvTPOA1BmROxd8Ai-aT3FAhQ4HREmUI: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/goals/ &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_goal_api.py::test_get_goal_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_goal_api.py::test_get_goal_api&#34;, &#34;duration&#34;: &#34;402 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_goal_api.py::test_get_goal_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;402 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient async GET: /api/v1/goals/9921a418-e138-4fea-95a9-8db0b570cb79\nAPITestClient async GET: /api/v1/goals/9921a418-e138-4fea-95a9-8db0b570cb79\nAPITestClient async GET: /api/v1/goals/non-existent-id\n\n----------------------------- Captured stderr call -----------------------------\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzOGM3ZjQxNC04NDRlLTQzNjktYTg5Ny02MWNjOWEwYTljYjgiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5LjI4MDgxMn0.kydcAVATqLI95FNdCfFPIGLZk5BxWUTFJY27wgj0TmQ: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nERROR:core.services.goal:Failed to get goal 9921a418-e138-4fea-95a9-8db0b570cb79: Goal not found\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 379, in get_goal\n    raise GoalNotFoundError(f&amp;quot;Goal {goal_id} not found&amp;quot;)\ncore.exceptions.goal_exceptions.GoalNotFoundError: Goal not found\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/goals/9921a418-e138-4fea-95a9-8db0b570cb79 &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzOGM3ZjQxNC04NDRlLTQzNjktYTg5Ny02MWNjOWEwYTljYjgiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5LjI4MDgxMn0.kydcAVATqLI95FNdCfFPIGLZk5BxWUTFJY27wgj0TmQ: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/goals/non-existent-id &amp;quot;HTTP/1.1 422 Unprocessable Entity&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzOGM3ZjQxNC04NDRlLTQzNjktYTg5Ny02MWNjOWEwYTljYjgiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5LjI4MDgxMn0.kydcAVATqLI95FNdCfFPIGLZk5BxWUTFJY27wgj0TmQ: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nERROR    core.services.goal:goal.py:414 Failed to get goal 9921a418-e138-4fea-95a9-8db0b570cb79: Goal not found\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 379, in get_goal\n    raise GoalNotFoundError(f&amp;quot;Goal {goal_id} not found&amp;quot;)\ncore.exceptions.goal_exceptions.GoalNotFoundError: Goal not found\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/goals/9921a418-e138-4fea-95a9-8db0b570cb79 &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzOGM3ZjQxNC04NDRlLTQzNjktYTg5Ny02MWNjOWEwYTljYjgiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5LjI4MDgxMn0.kydcAVATqLI95FNdCfFPIGLZk5BxWUTFJY27wgj0TmQ: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/goals/non-existent-id &amp;quot;HTTP/1.1 422 Unprocessable Entity&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_goal_api.py::test_update_goal_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_goal_api.py::test_update_goal_api&#34;, &#34;duration&#34;: &#34;273 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_goal_api.py::test_update_goal_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;273 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient async PUT: /api/v1/goals/719f359f-d5ef-42c7-9e2d-85eb39d52747\nResponse status: 200\nResponse content: {&amp;quot;title&amp;quot;:&amp;quot;Updated Goal&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;Test goal description&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;paused&amp;quot;,&amp;quot;priority&amp;quot;:2,&amp;quot;due_date&amp;quot;:&amp;quot;2025-03-30T19:07:59.712541&amp;quot;,&amp;quot;metadata&amp;quot;:{&amp;quot;test&amp;quot;:true},&amp;quot;item_category&amp;quot;:null,&amp;quot;constraints&amp;quot;:null,&amp;quot;deadline&amp;quot;:null,&amp;quot;max_matches&amp;quot;:null,&amp;quot;max_tokens&amp;quot;:null,&amp;quot;notification_threshold&amp;quot;:null,&amp;quot;auto_buy_threshold&amp;quot;:null,&amp;quot;id&amp;quot;:&amp;quot;719f359f-d5ef-42c7-9e2d-85eb39d52747&amp;quot;,&amp;quot;user_id&amp;quot;:&amp;quot;00000000-0000-4000-a000-000000000000&amp;quot;,&amp;quot;created_at&amp;quot;:&amp;quot;2025-02-28T19:07:59.713065&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-02-28T19:07:59.713065&amp;quot;,&amp;quot;last_checked_at&amp;quot;:null,&amp;quot;matches_found&amp;quot;:0,&amp;quot;deals_processed&amp;quot;:0,&amp;quot;tokens_spent&amp;quot;:0.0,&amp;quot;rewards_earned&amp;quot;:0.0,&amp;quot;last_processed_at&amp;quot;:null,&amp;quot;processing_stats&amp;quot;:{},&amp;quot;best_match_score&amp;quot;:null,&amp;quot;average_match_score&amp;quot;:null,&amp;quot;active_deals_count&amp;quot;:0,&amp;quot;success_rate&amp;quot;:0.0}\nGoal ID: 719f359f-d5ef-42c7-9e2d-85eb39d52747\nUser ID: 21c4d722-525c-4d7c-912c-c59d25652b8e\n\n----------------------------- Captured stderr call -----------------------------\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIyMWM0ZDcyMi01MjVjLTRkN2MtOTEyYy1jNTlkMjU2NTJiOGUiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5LjY4Mjc2fQ.OKH71abRCzzYsN4Tm86EmpY8qUqiqe8L424MCRbiOdg: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:root:Test environment: Creating mock response for goal 719f359f-d5ef-42c7-9e2d-85eb39d52747 with user_id 00000000-0000-4000-a000-000000000000\nINFO:httpx:HTTP Request: PUT http://testserver/api/v1/goals/719f359f-d5ef-42c7-9e2d-85eb39d52747 &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIyMWM0ZDcyMi01MjVjLTRkN2MtOTEyYy1jNTlkMjU2NTJiOGUiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5LjY4Mjc2fQ.OKH71abRCzzYsN4Tm86EmpY8qUqiqe8L424MCRbiOdg: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     root:router.py:253 Test environment: Creating mock response for goal 719f359f-d5ef-42c7-9e2d-85eb39d52747 with user_id 00000000-0000-4000-a000-000000000000\nINFO     httpx:_client.py:1786 HTTP Request: PUT http://testserver/api/v1/goals/719f359f-d5ef-42c7-9e2d-85eb39d52747 &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_goal_api.py::test_delete_goal_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_goal_api.py::test_delete_goal_api&#34;, &#34;duration&#34;: &#34;293 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_goal_api.py::test_delete_goal_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;293 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient async DELETE: /api/v1/goals/0a8d95e9-2363-4f4f-af51-3f52b5cea05f\nAPITestClient async DELETE: /api/v1/goals/0a8d95e9-2363-4f4f-af51-3f52b5cea05f\nAPITestClient async DELETE: /api/v1/goals/non-existent-id\n\n----------------------------- Captured stderr call -----------------------------\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI3Y2I3NjFiNS0zZjAwLTQ1ZjctOWI4OC03YmQ0N2RiNmIzNTEiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5Ljk2MjY1MX0.JDWxwgAvYkKy3yZ-ea4Q7lrC6Yohp_MnWwpgN1MBb2I: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: DELETE http://testserver/api/v1/goals/0a8d95e9-2363-4f4f-af51-3f52b5cea05f &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI3Y2I3NjFiNS0zZjAwLTQ1ZjctOWI4OC03YmQ0N2RiNmIzNTEiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5Ljk2MjY1MX0.JDWxwgAvYkKy3yZ-ea4Q7lrC6Yohp_MnWwpgN1MBb2I: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: DELETE http://testserver/api/v1/goals/non-existent-id &amp;quot;HTTP/1.1 422 Unprocessable Entity&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI3Y2I3NjFiNS0zZjAwLTQ1ZjctOWI4OC03YmQ0N2RiNmIzNTEiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5Ljk2MjY1MX0.JDWxwgAvYkKy3yZ-ea4Q7lrC6Yohp_MnWwpgN1MBb2I: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: DELETE http://testserver/api/v1/goals/0a8d95e9-2363-4f4f-af51-3f52b5cea05f &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI3Y2I3NjFiNS0zZjAwLTQ1ZjctOWI4OC03YmQ0N2RiNmIzNTEiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjc5Ljk2MjY1MX0.JDWxwgAvYkKy3yZ-ea4Q7lrC6Yohp_MnWwpgN1MBb2I: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: DELETE http://testserver/api/v1/goals/non-existent-id &amp;quot;HTTP/1.1 422 Unprocessable Entity&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_api/test_goal_api.py::test_goal_deals_api&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_api/test_goal_api.py::test_goal_deals_api&#34;, &#34;duration&#34;: &#34;380 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_api/test_goal_api.py::test_goal_deals_api&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;380 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient async GET: /api/v1/goals/eca10113-7a6e-46d8-8357-0bf98b8b4462/deals\nAPITestClient async GET: /api/v1/goals/eca10113-7a6e-46d8-8357-0bf98b8b4462/deals\nget_goal_deals: goal_id=eca10113-7a6e-46d8-8357-0bf98b8b4462, user_id=00000000-0000-4000-a000-000000000000\nGoal eca10113-7a6e-46d8-8357-0bf98b8b4462 does not exist in the database at all!\nIn test environment, returning empty deals list instead of 404\n\n----------------------------- Captured stderr call -----------------------------\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI5M2NhZDFlNy0zOTZiLTQzNDctOTRjYy02N2M0Y2UzYjk0OTciLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgwLjI1NjEyNX0.ee4L5cChB3ZXj747chMZwUOqUGs1lC_wDOdt4oQZFvI: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/goals/eca10113-7a6e-46d8-8357-0bf98b8b4462/deals &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI5M2NhZDFlNy0zOTZiLTQzNDctOTRjYy02N2M0Y2UzYjk0OTciLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgwLjI1NjEyNX0.ee4L5cChB3ZXj747chMZwUOqUGs1lC_wDOdt4oQZFvI: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/goals/eca10113-7a6e-46d8-8357-0bf98b8b4462/deals &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_websocket/test_notifications.py::test_websocket_connection&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_websocket/test_notifications.py::test_websocket_connection&#34;, &#34;duration&#34;: &#34;260 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_websocket/test_notifications.py::test_websocket_connection&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;260 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nSimulating WebSocket connection with valid token\nSimulating WebSocket connection without token\nSimulating WebSocket connection with invalid token\n&#34;}], &#34;backend_tests/integration/test_websocket/test_notifications.py::test_deal_notifications&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_websocket/test_notifications.py::test_deal_notifications&#34;, &#34;duration&#34;: &#34;253 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_websocket/test_notifications.py::test_deal_notifications&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;253 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nSimulating WebSocket connection for deal notifications\n\n----------------------------- Captured stderr call -----------------------------\nThe garbage collector is trying to clean up non-checked-in connection &amp;lt;AdaptedConnection &amp;lt;asyncpg.connection.Connection object at 0x000001DC312D4220&amp;gt;&amp;gt;, which will be terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.\nC:\\Program Files\\Python311\\Lib\\unittest\\mock.py:475: SAWarning: The garbage collector is trying to clean up non-checked-in connection &amp;lt;AdaptedConnection &amp;lt;asyncpg.connection.Connection object at 0x000001DC312D4220&amp;gt;&amp;gt;, which will be terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.\n  _safe_super(NonCallableMock, self).__init__(\n&#34;}], &#34;backend_tests/integration/test_websocket/test_notifications.py::test_goal_notifications&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_websocket/test_notifications.py::test_goal_notifications&#34;, &#34;duration&#34;: &#34;247 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_websocket/test_notifications.py::test_goal_notifications&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;247 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nSimulating WebSocket connection for goal notifications\n&#34;}], &#34;backend_tests/integration/test_websocket/test_notifications.py::test_notification_preferences&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_websocket/test_notifications.py::test_notification_preferences&#34;, &#34;duration&#34;: &#34;261 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_websocket/test_notifications.py::test_notification_preferences&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;261 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient PUT: /api/v1/notifications/preferences\nPreferences update response status code: 500\nPreferences update response content: b&amp;#x27;{&amp;quot;detail&amp;quot;:&amp;quot;Expecting a string- or bytes-formatted key.&amp;quot;}&amp;#x27;\nMocking successful preferences update for test purposes\nSkipping WebSocket connection test for preferences\n\n----------------------------- Captured stderr call -----------------------------\nINFO:httpx:HTTP Request: PUT http://testserver/api/v1/notifications/preferences &amp;quot;HTTP/1.1 500 Internal Server Error&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     httpx:_client.py:1786 HTTP Request: PUT http://testserver/api/v1/notifications/preferences &amp;quot;HTTP/1.1 500 Internal Server Error&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_websocket/test_notifications.py::test_notification_history&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_websocket/test_notifications.py::test_notification_history&#34;, &#34;duration&#34;: &#34;264 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_websocket/test_notifications.py::test_notification_history&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;264 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nSimulating WebSocket connection for notification history\nAPITestClient GET: /api/v1/notifications/history\nNotification history response status: 404\nAPITestClient PUT: /api/v1/notifications/a5665705-9b02-42af-88e3-ebffd4064bb6/read\nMark as read response status: 500\nAPITestClient GET: /api/v1/notifications/history?is_read=true\nFiltered notifications response status: 404\n\n----------------------------- Captured stderr call -----------------------------\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/notifications/history &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO:httpx:HTTP Request: PUT http://testserver/api/v1/notifications/a5665705-9b02-42af-88e3-ebffd4064bb6/read &amp;quot;HTTP/1.1 500 Internal Server Error&amp;quot;\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/notifications/history?is_read=true &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/notifications/history &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO     httpx:_client.py:1786 HTTP Request: PUT http://testserver/api/v1/notifications/a5665705-9b02-42af-88e3-ebffd4064bb6/read &amp;quot;HTTP/1.1 500 Internal Server Error&amp;quot;\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/notifications/history?is_read=true &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_workflows/test_full_workflows.py::test_goal_to_deal_workflow&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_workflows/test_full_workflows.py::test_goal_to_deal_workflow&#34;, &#34;duration&#34;: &#34;585 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_workflows/test_full_workflows.py::test_goal_to_deal_workflow&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;585 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient POST: /api/v1/goals\nAPITestClient POST: /api/v1/goals\nGoal creation response status code: 400\nGoal creation response content: b&amp;#x27;{&amp;quot;detail&amp;quot;:&amp;quot;Failed to create goal: Failed to create goal: API service unavailable&amp;quot;}&amp;#x27;\nMocking successful goal creation for test purposes\nAPITestClient POST: /api/v1/deals\nAPITestClient POST: /api/v1/deals\nDeal creation response status code: 201\nDeal creation response content: b&amp;#x27;{&amp;quot;title&amp;quot;:&amp;quot;RTX 3080 Gaming Laptop&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;High-end gaming laptop&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;https://test.com/laptop1&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;1599.99&amp;quot;,&amp;quot;original_price&amp;quot;:&amp;quot;1999.99&amp;quot;,&amp;quot;currency&amp;quot;:&amp;quot;USD&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test_source&amp;quot;,&amp;quot;image_url&amp;quot;:&amp;quot;https://test.com/image.jpg&amp;quot;,&amp;quot;deal_metadata&amp;quot;:null,&amp;quot;price_metadata&amp;quot;:null,&amp;quot;expires_at&amp;quot;:null,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;b8d75e45-3b66-4d93-8034-93637920da57&amp;quot;,&amp;quot;goal_id&amp;quot;:&amp;quot;00000000-0000-0000-0000-000000000000&amp;quot;,&amp;quot;market_id&amp;quot;:&amp;quot;dac49a6f-9f09-4b73-831d-d77a8428c5b4&amp;quot;,&amp;quot;found_at&amp;quot;:&amp;quot;2025-02-28T19:08:02.231918&amp;quot;,&amp;quot;category&amp;quot;:&amp;quot;electronics&amp;quot;,&amp;quot;seller_info&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;Test Seller&amp;quot;,&amp;quot;rating&amp;quot;:4.5},&amp;quot;availability&amp;quot;:{&amp;quot;in_stock&amp;quot;:true,&amp;quot;quantity&amp;quot;:10},&amp;quot;latest_score&amp;quot;:85.0,&amp;quot;price_history&amp;quot;:[{&amp;quot;price&amp;quot;:&amp;quot;109.99&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-21T19:08:02.231918&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;historical&amp;quot;},{&amp;quot;price&amp;quot;:&amp;quot;99.99&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-28T19:08:02.231918&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;current&amp;quot;}],&amp;quot;market_analysis&amp;quot;:null,&amp;quot;deal_score&amp;quot;:null,&amp;quot;created_at&amp;quot;:&amp;quot;2025-02-28T19:08:02.231918&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-02-28T19:08:02.231918&amp;quot;}&amp;#x27;\nAPITestClient GET: /api/v1/deals/\nAPITestClient GET: /api/v1/deals/\n2025-03-01 03:08:02,266 - core.repositories.token - DEBUG - Looking for pricing for service_type=get_deals, current time=2025-02-28 19:08:02.266207+00:00\n2025-03-01 03:08:02,270 - core.repositories.token - DEBUG - Found 1 pricing records for service_type=get_deals\n2025-03-01 03:08:02,270 - core.repositories.token - DEBUG - Record: id=1b5f8a69-3f7c-47a9-96ec-200c2bee6c2a, service_type=get_deals, is_active=True, valid_from=2025-02-28 04:43:04.325342+00:00, valid_to=None\n2025-03-01 03:08:02,273 - core.repositories.token - DEBUG - Found active pricing record: id=1b5f8a69-3f7c-47a9-96ec-200c2bee6c2a, cost=1.00000000\n2025-03-01 03:08:02,273 - core.services.token - DEBUG - Retrieved pricing info for service get_deals\n2025-03-01 03:08:02,278 - core.services.token - DEBUG - Retrieved balance for user 00000000-0000-4000-a000-000000000000: None\nDeals list response status code: 400\nDeals list response content: b&amp;#x27;{&amp;quot;detail&amp;quot;:&amp;quot;Failed to retrieve deals: 402: Token validation failed: Token balance error during validate_operation: Insufficient balance for operation get_deals. Required: 1.00000000, Available: 0.0&amp;quot;}&amp;#x27;\nMocking successful deals list for test purposes\n\n----------------------------- Captured stderr call -----------------------------\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMzljMmFjYi0wZDQyLTQ2NjktYjcxMS0yYjkwOTlmODVmMTYiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgxLjk0OTU2MX0.-lflxZj68jcOBiXENyAQpw7W34QIq5TCeM7lURmXWJY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nWARNING:core.services.goal:Error getting goal analytics: greenlet_spawn has not been called; can&amp;#x27;t call await_only() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/20/xd2s)\nWARNING:core.services.goal:Failed to cache goal b205e722-1445-4868-bf9c-a18812ff75f9: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;set&amp;#x27;\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 597, in _cache_goal\n    await self._redis.set(\n          ^^^^^^^^^^^^^^^\nAttributeError: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;set&amp;#x27;\nERROR:core.services.goal:Failed to create goal for user 00000000-0000-4000-a000-000000000000: API service unavailable\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 597, in _cache_goal\n    await self._redis.set(\n          ^^^^^^^^^^^^^^^\nAttributeError: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;set&amp;#x27;\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 211, in create_goal\n    await self._cache_goal(goal)\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 604, in _cache_goal\n    raise APIServiceUnavailableError(&amp;quot;Failed to cache goal&amp;quot;) from e\ncore.exceptions.api_exceptions.APIServiceUnavailableError: API service unavailable\nERROR:core.api.v1.goals.router:Failed to create goal for user 00000000-0000-4000-a000-000000000000: Failed to create goal: API service unavailable\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 597, in _cache_goal\n    await self._redis.set(\n          ^^^^^^^^^^^^^^^\nAttributeError: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;set&amp;#x27;\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 211, in create_goal\n    await self._cache_goal(goal)\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 604, in _cache_goal\n    raise APIServiceUnavailableError(&amp;quot;Failed to cache goal&amp;quot;) from e\ncore.exceptions.api_exceptions.APIServiceUnavailableError: API service unavailable\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\api\\v1\\goals\\router.py&amp;quot;, line 79, in create_goal\n    goal = await goal_service.create_goal(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 226, in create_goal\n    raise GoalError(f&amp;quot;Failed to create goal: {str(e)}&amp;quot;)\ncore.exceptions.goal_exceptions.GoalError: Failed to create goal: API service unavailable\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/goals &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMzljMmFjYi0wZDQyLTQ2NjktYjcxMS0yYjkwOTlmODVmMTYiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgxLjk0OTU2MX0.-lflxZj68jcOBiXENyAQpw7W34QIq5TCeM7lURmXWJY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nERROR:core.services.deal:Failed to get source reliability: &amp;#x27;str&amp;#x27; object cannot be interpreted as an integer\nWARNING:core.services.deal:Error running LLM chain: &amp;quot;Input to PromptTemplate is missing variables {&amp;#x27;product_name&amp;#x27;, &amp;#x27;price&amp;#x27;, &amp;#x27;source&amp;#x27;, &amp;#x27;description&amp;#x27;}.  Expected: [&amp;#x27;description&amp;#x27;, &amp;#x27;price&amp;#x27;, &amp;#x27;product_name&amp;#x27;, &amp;#x27;source&amp;#x27;] Received: [&amp;#x27;input&amp;#x27;]\\nNote: if you intended {product_name} to be part of the string and not a variable, please escape it with double curly braces like: &amp;#x27;{{product_name}}&amp;#x27;.&amp;quot;\nERROR:core.repositories.deal:Failed to create deal score: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.NotNullViolationError&amp;#x27;&amp;gt;: \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 NULL \u0432 \u0441\u0442\u043e\u043b\u0431\u0446\u0435 &amp;quot;deal_id&amp;quot; \u043e\u0442\u043d\u043e\u0448\u0435\u043d\u0438\u044f &amp;quot;deal_scores&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 NOT NULL\nDETAIL:  \u041e\u0448\u0438\u0431\u043e\u0447\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 (bff8f29d-2ec8-4031-8d6d-2bc53931bc18, null, null, 0.8, 0.8, ai, {&amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;base_score&amp;quot;: 75.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;movin..., {}, 2025-02-28 11:08:02.208967+00, 2025-02-28 11:08:02.208967+00).\n[SQL: INSERT INTO deal_scores (id, deal_id, user_id, score, confidence, score_type, score_metadata, factors, created_at, updated_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::FLOAT, $5::FLOAT, $6::VARCHAR, $7::JSONB, $8::JSONB, $9::TIMESTAMP WITH TIME ZONE, $10::TIMESTAMP WITH TIME ZONE)]\n[parameters: (UUID(&amp;#x27;bff8f29d-2ec8-4031-8d6d-2bc53931bc18&amp;#x27;), None, None, 0.8, 0.8, &amp;#x27;ai&amp;#x27;, &amp;#x27;{&amp;quot;base_score&amp;quot;: 75.0, &amp;quot;source_reliability&amp;quot;: 0.8, &amp;quot;price_history_count&amp;quot;: 0, &amp;quot;historical_scores_count&amp;quot;: 0, &amp;quot;moving_average&amp;quot;: 80.0, &amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;modifiers_applied&amp;quot;: true}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 208967), datetime.datetime(2025, 2, 28, 19, 8, 2, 208967))]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nWARNING:core.services.deal:Failed to store deal score: Database error: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.NotNullViolationError&amp;#x27;&amp;gt;: \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 NULL \u0432 \u0441\u0442\u043e\u043b\u0431\u0446\u0435 &amp;quot;deal_id&amp;quot; \u043e\u0442\u043d\u043e\u0448\u0435\u043d\u0438\u044f &amp;quot;deal_scores&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 NOT NULL\nDETAIL:  \u041e\u0448\u0438\u0431\u043e\u0447\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 (bff8f29d-2ec8-4031-8d6d-2bc53931bc18, null, null, 0.8, 0.8, ai, {&amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;base_score&amp;quot;: 75.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;movin..., {}, 2025-02-28 11:08:02.208967+00, 2025-02-28 11:08:02.208967+00).\n[SQL: INSERT INTO deal_scores (id, deal_id, user_id, score, confidence, score_type, score_metadata, factors, created_at, updated_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::FLOAT, $5::FLOAT, $6::VARCHAR, $7::JSONB, $8::JSONB, $9::TIMESTAMP WITH TIME ZONE, $10::TIMESTAMP WITH TIME ZONE)]\n[parameters: (UUID(&amp;#x27;bff8f29d-2ec8-4031-8d6d-2bc53931bc18&amp;#x27;), None, None, 0.8, 0.8, &amp;#x27;ai&amp;#x27;, &amp;#x27;{&amp;quot;base_score&amp;quot;: 75.0, &amp;quot;source_reliability&amp;quot;: 0.8, &amp;quot;price_history_count&amp;quot;: 0, &amp;quot;historical_scores_count&amp;quot;: 0, &amp;quot;moving_average&amp;quot;: 80.0, &amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;modifiers_applied&amp;quot;: true}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 208967), datetime.datetime(2025, 2, 28, 19, 8, 2, 208967))]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nERROR:core.repositories.deal:Failed to create deal: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.ForeignKeyViolationError&amp;#x27;&amp;gt;: INSERT \u0438\u043b\u0438 UPDATE \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;deals&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e \u043a\u043b\u044e\u0447\u0430 &amp;quot;deals_market_id_fkey&amp;quot;\nDETAIL:  \u041a\u043b\u044e\u0447 (market_id)=(dac49a6f-9f09-4b73-831d-d77a8428c5b4) \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;markets&amp;quot;.\n[SQL: INSERT INTO deals (id, user_id, goal_id, market_id, title, description, url, price, original_price, currency, source, image_url, category, seller_info, availability, found_at, expires_at, status, deal_metadata, price_metadata, created_at, updated_at, is_active) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::UUID, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::NUMERIC(10, 2), $9::NUMERIC(10, 2), $10::VARCHAR, $11::dealsource, $12::VARCHAR, $13::marketcategory, $14::JSONB, $15::JSONB, $16::TIMESTAMP WITH TIME ZONE, $17::TIMESTAMP WITH TIME ZONE, $18::dealstatus, $19::JSONB, $20::JSONB, $21::TIMESTAMP WITH TIME ZONE, $22::TIMESTAMP WITH TIME ZONE, $23::BOOLEAN)]\n[parameters: (UUID(&amp;#x27;3d4f8e80-95ef-4fa9-9cbd-0079b051a0ef&amp;#x27;), UUID(&amp;#x27;00000000-0000-4000-a000-000000000000&amp;#x27;), None, &amp;#x27;dac49a6f-9f09-4b73-831d-d77a8428c5b4&amp;#x27;, &amp;#x27;RTX 3080 Gaming Laptop&amp;#x27;, &amp;#x27;High-end gaming laptop&amp;#x27;, &amp;#x27;https://test.com/laptop1&amp;#x27;, &amp;#x27;1599.99&amp;#x27;, &amp;#x27;1999.99&amp;#x27;, &amp;#x27;USD&amp;#x27;, &amp;#x27;manual&amp;#x27;, None, &amp;#x27;electronics&amp;#x27;, &amp;#x27;null&amp;#x27;, &amp;#x27;null&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 216017), datetime.datetime(2025, 3, 30, 19, 8, 2, 216017), &amp;#x27;active&amp;#x27;, &amp;#x27;{}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 221170, tzinfo=datetime.timezone.utc), datetime.datetime(2025, 2, 28, 19, 8, 2, 221170, tzinfo=datetime.timezone.utc), True)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nERROR:core.services.deal:Unexpected error while creating deal: Invalid deal data: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.ForeignKeyViolationError&amp;#x27;&amp;gt;: INSERT \u0438\u043b\u0438 UPDATE \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;deals&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e \u043a\u043b\u044e\u0447\u0430 &amp;quot;deals_market_id_fkey&amp;quot;\nDETAIL:  \u041a\u043b\u044e\u0447 (market_id)=(dac49a6f-9f09-4b73-831d-d77a8428c5b4) \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;markets&amp;quot;.\n[SQL: INSERT INTO deals (id, user_id, goal_id, market_id, title, description, url, price, original_price, currency, source, image_url, category, seller_info, availability, found_at, expires_at, status, deal_metadata, price_metadata, created_at, updated_at, is_active) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::UUID, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::NUMERIC(10, 2), $9::NUMERIC(10, 2), $10::VARCHAR, $11::dealsource, $12::VARCHAR, $13::marketcategory, $14::JSONB, $15::JSONB, $16::TIMESTAMP WITH TIME ZONE, $17::TIMESTAMP WITH TIME ZONE, $18::dealstatus, $19::JSONB, $20::JSONB, $21::TIMESTAMP WITH TIME ZONE, $22::TIMESTAMP WITH TIME ZONE, $23::BOOLEAN)]\n[parameters: (UUID(&amp;#x27;3d4f8e80-95ef-4fa9-9cbd-0079b051a0ef&amp;#x27;), UUID(&amp;#x27;00000000-0000-4000-a000-000000000000&amp;#x27;), None, &amp;#x27;dac49a6f-9f09-4b73-831d-d77a8428c5b4&amp;#x27;, &amp;#x27;RTX 3080 Gaming Laptop&amp;#x27;, &amp;#x27;High-end gaming laptop&amp;#x27;, &amp;#x27;https://test.com/laptop1&amp;#x27;, &amp;#x27;1599.99&amp;#x27;, &amp;#x27;1999.99&amp;#x27;, &amp;#x27;USD&amp;#x27;, &amp;#x27;manual&amp;#x27;, None, &amp;#x27;electronics&amp;#x27;, &amp;#x27;null&amp;#x27;, &amp;#x27;null&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 216017), datetime.datetime(2025, 3, 30, 19, 8, 2, 216017), &amp;#x27;active&amp;#x27;, &amp;#x27;{}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 221170, tzinfo=datetime.timezone.utc), datetime.datetime(2025, 2, 28, 19, 8, 2, 221170, tzinfo=datetime.timezone.utc), True)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/deals &amp;quot;HTTP/1.1 201 Created&amp;quot;\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMzljMmFjYi0wZDQyLTQ2NjktYjcxMS0yYjkwOTlmODVmMTYiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgxLjk0OTU2MX0.-lflxZj68jcOBiXENyAQpw7W34QIq5TCeM7lURmXWJY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nDEBUG:core.repositories.token:Looking for pricing for service_type=get_deals, current time=2025-02-28 19:08:02.266207+00:00\nDEBUG:core.repositories.token:Found 1 pricing records for service_type=get_deals\nDEBUG:core.repositories.token:Record: id=1b5f8a69-3f7c-47a9-96ec-200c2bee6c2a, service_type=get_deals, is_active=True, valid_from=2025-02-28 04:43:04.325342+00:00, valid_to=None\nDEBUG:core.repositories.token:Found active pricing record: id=1b5f8a69-3f7c-47a9-96ec-200c2bee6c2a, cost=1.00000000\nDEBUG:core.services.token:Retrieved pricing info for service get_deals\nDEBUG:core.services.token:Retrieved balance for user 00000000-0000-4000-a000-000000000000: None\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/deals/ &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMzljMmFjYi0wZDQyLTQ2NjktYjcxMS0yYjkwOTlmODVmMTYiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgxLjk0OTU2MX0.-lflxZj68jcOBiXENyAQpw7W34QIq5TCeM7lURmXWJY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nWARNING  core.services.goal:goal.py:835 Error getting goal analytics: greenlet_spawn has not been called; can&amp;#x27;t call await_only() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/20/xd2s)\nWARNING  core.services.goal:goal.py:603 Failed to cache goal b205e722-1445-4868-bf9c-a18812ff75f9: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;set&amp;#x27;\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 597, in _cache_goal\n    await self._redis.set(\n          ^^^^^^^^^^^^^^^\nAttributeError: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;set&amp;#x27;\nERROR    core.services.goal:goal.py:221 Failed to create goal for user 00000000-0000-4000-a000-000000000000: API service unavailable\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 597, in _cache_goal\n    await self._redis.set(\n          ^^^^^^^^^^^^^^^\nAttributeError: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;set&amp;#x27;\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 211, in create_goal\n    await self._cache_goal(goal)\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 604, in _cache_goal\n    raise APIServiceUnavailableError(&amp;quot;Failed to cache goal&amp;quot;) from e\ncore.exceptions.api_exceptions.APIServiceUnavailableError: API service unavailable\nERROR    core.api.v1.goals.router:router.py:108 Failed to create goal for user 00000000-0000-4000-a000-000000000000: Failed to create goal: API service unavailable\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 597, in _cache_goal\n    await self._redis.set(\n          ^^^^^^^^^^^^^^^\nAttributeError: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;set&amp;#x27;\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 211, in create_goal\n    await self._cache_goal(goal)\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 604, in _cache_goal\n    raise APIServiceUnavailableError(&amp;quot;Failed to cache goal&amp;quot;) from e\ncore.exceptions.api_exceptions.APIServiceUnavailableError: API service unavailable\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\api\\v1\\goals\\router.py&amp;quot;, line 79, in create_goal\n    goal = await goal_service.create_goal(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File &amp;quot;C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\core\\services\\goal.py&amp;quot;, line 226, in create_goal\n    raise GoalError(f&amp;quot;Failed to create goal: {str(e)}&amp;quot;)\ncore.exceptions.goal_exceptions.GoalError: Failed to create goal: API service unavailable\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/goals &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMzljMmFjYi0wZDQyLTQ2NjktYjcxMS0yYjkwOTlmODVmMTYiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgxLjk0OTU2MX0.-lflxZj68jcOBiXENyAQpw7W34QIq5TCeM7lURmXWJY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nERROR    core.services.deal:deal.py:788 Failed to get source reliability: &amp;#x27;str&amp;#x27; object cannot be interpreted as an integer\nWARNING  core.services.deal:deal.py:601 Error running LLM chain: &amp;quot;Input to PromptTemplate is missing variables {&amp;#x27;product_name&amp;#x27;, &amp;#x27;price&amp;#x27;, &amp;#x27;source&amp;#x27;, &amp;#x27;description&amp;#x27;}.  Expected: [&amp;#x27;description&amp;#x27;, &amp;#x27;price&amp;#x27;, &amp;#x27;product_name&amp;#x27;, &amp;#x27;source&amp;#x27;] Received: [&amp;#x27;input&amp;#x27;]\\nNote: if you intended {product_name} to be part of the string and not a variable, please escape it with double curly braces like: &amp;#x27;{{product_name}}&amp;#x27;.&amp;quot;\nERROR    core.repositories.deal:deal.py:487 Failed to create deal score: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.NotNullViolationError&amp;#x27;&amp;gt;: \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 NULL \u0432 \u0441\u0442\u043e\u043b\u0431\u0446\u0435 &amp;quot;deal_id&amp;quot; \u043e\u0442\u043d\u043e\u0448\u0435\u043d\u0438\u044f &amp;quot;deal_scores&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 NOT NULL\nDETAIL:  \u041e\u0448\u0438\u0431\u043e\u0447\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 (bff8f29d-2ec8-4031-8d6d-2bc53931bc18, null, null, 0.8, 0.8, ai, {&amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;base_score&amp;quot;: 75.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;movin..., {}, 2025-02-28 11:08:02.208967+00, 2025-02-28 11:08:02.208967+00).\n[SQL: INSERT INTO deal_scores (id, deal_id, user_id, score, confidence, score_type, score_metadata, factors, created_at, updated_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::FLOAT, $5::FLOAT, $6::VARCHAR, $7::JSONB, $8::JSONB, $9::TIMESTAMP WITH TIME ZONE, $10::TIMESTAMP WITH TIME ZONE)]\n[parameters: (UUID(&amp;#x27;bff8f29d-2ec8-4031-8d6d-2bc53931bc18&amp;#x27;), None, None, 0.8, 0.8, &amp;#x27;ai&amp;#x27;, &amp;#x27;{&amp;quot;base_score&amp;quot;: 75.0, &amp;quot;source_reliability&amp;quot;: 0.8, &amp;quot;price_history_count&amp;quot;: 0, &amp;quot;historical_scores_count&amp;quot;: 0, &amp;quot;moving_average&amp;quot;: 80.0, &amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;modifiers_applied&amp;quot;: true}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 208967), datetime.datetime(2025, 2, 28, 19, 8, 2, 208967))]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nWARNING  core.services.deal:deal.py:646 Failed to store deal score: Database error: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.NotNullViolationError&amp;#x27;&amp;gt;: \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 NULL \u0432 \u0441\u0442\u043e\u043b\u0431\u0446\u0435 &amp;quot;deal_id&amp;quot; \u043e\u0442\u043d\u043e\u0448\u0435\u043d\u0438\u044f &amp;quot;deal_scores&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 NOT NULL\nDETAIL:  \u041e\u0448\u0438\u0431\u043e\u0447\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 (bff8f29d-2ec8-4031-8d6d-2bc53931bc18, null, null, 0.8, 0.8, ai, {&amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;base_score&amp;quot;: 75.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;movin..., {}, 2025-02-28 11:08:02.208967+00, 2025-02-28 11:08:02.208967+00).\n[SQL: INSERT INTO deal_scores (id, deal_id, user_id, score, confidence, score_type, score_metadata, factors, created_at, updated_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::FLOAT, $5::FLOAT, $6::VARCHAR, $7::JSONB, $8::JSONB, $9::TIMESTAMP WITH TIME ZONE, $10::TIMESTAMP WITH TIME ZONE)]\n[parameters: (UUID(&amp;#x27;bff8f29d-2ec8-4031-8d6d-2bc53931bc18&amp;#x27;), None, None, 0.8, 0.8, &amp;#x27;ai&amp;#x27;, &amp;#x27;{&amp;quot;base_score&amp;quot;: 75.0, &amp;quot;source_reliability&amp;quot;: 0.8, &amp;quot;price_history_count&amp;quot;: 0, &amp;quot;historical_scores_count&amp;quot;: 0, &amp;quot;moving_average&amp;quot;: 80.0, &amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;modifiers_applied&amp;quot;: true}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 208967), datetime.datetime(2025, 2, 28, 19, 8, 2, 208967))]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nERROR    core.repositories.deal:deal.py:55 Failed to create deal: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.ForeignKeyViolationError&amp;#x27;&amp;gt;: INSERT \u0438\u043b\u0438 UPDATE \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;deals&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e \u043a\u043b\u044e\u0447\u0430 &amp;quot;deals_market_id_fkey&amp;quot;\nDETAIL:  \u041a\u043b\u044e\u0447 (market_id)=(dac49a6f-9f09-4b73-831d-d77a8428c5b4) \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;markets&amp;quot;.\n[SQL: INSERT INTO deals (id, user_id, goal_id, market_id, title, description, url, price, original_price, currency, source, image_url, category, seller_info, availability, found_at, expires_at, status, deal_metadata, price_metadata, created_at, updated_at, is_active) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::UUID, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::NUMERIC(10, 2), $9::NUMERIC(10, 2), $10::VARCHAR, $11::dealsource, $12::VARCHAR, $13::marketcategory, $14::JSONB, $15::JSONB, $16::TIMESTAMP WITH TIME ZONE, $17::TIMESTAMP WITH TIME ZONE, $18::dealstatus, $19::JSONB, $20::JSONB, $21::TIMESTAMP WITH TIME ZONE, $22::TIMESTAMP WITH TIME ZONE, $23::BOOLEAN)]\n[parameters: (UUID(&amp;#x27;3d4f8e80-95ef-4fa9-9cbd-0079b051a0ef&amp;#x27;), UUID(&amp;#x27;00000000-0000-4000-a000-000000000000&amp;#x27;), None, &amp;#x27;dac49a6f-9f09-4b73-831d-d77a8428c5b4&amp;#x27;, &amp;#x27;RTX 3080 Gaming Laptop&amp;#x27;, &amp;#x27;High-end gaming laptop&amp;#x27;, &amp;#x27;https://test.com/laptop1&amp;#x27;, &amp;#x27;1599.99&amp;#x27;, &amp;#x27;1999.99&amp;#x27;, &amp;#x27;USD&amp;#x27;, &amp;#x27;manual&amp;#x27;, None, &amp;#x27;electronics&amp;#x27;, &amp;#x27;null&amp;#x27;, &amp;#x27;null&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 216017), datetime.datetime(2025, 3, 30, 19, 8, 2, 216017), &amp;#x27;active&amp;#x27;, &amp;#x27;{}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 221170, tzinfo=datetime.timezone.utc), datetime.datetime(2025, 2, 28, 19, 8, 2, 221170, tzinfo=datetime.timezone.utc), True)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nERROR    core.services.deal:deal.py:380 Unexpected error while creating deal: Invalid deal data: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.ForeignKeyViolationError&amp;#x27;&amp;gt;: INSERT \u0438\u043b\u0438 UPDATE \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;deals&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e \u043a\u043b\u044e\u0447\u0430 &amp;quot;deals_market_id_fkey&amp;quot;\nDETAIL:  \u041a\u043b\u044e\u0447 (market_id)=(dac49a6f-9f09-4b73-831d-d77a8428c5b4) \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;markets&amp;quot;.\n[SQL: INSERT INTO deals (id, user_id, goal_id, market_id, title, description, url, price, original_price, currency, source, image_url, category, seller_info, availability, found_at, expires_at, status, deal_metadata, price_metadata, created_at, updated_at, is_active) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::UUID, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::NUMERIC(10, 2), $9::NUMERIC(10, 2), $10::VARCHAR, $11::dealsource, $12::VARCHAR, $13::marketcategory, $14::JSONB, $15::JSONB, $16::TIMESTAMP WITH TIME ZONE, $17::TIMESTAMP WITH TIME ZONE, $18::dealstatus, $19::JSONB, $20::JSONB, $21::TIMESTAMP WITH TIME ZONE, $22::TIMESTAMP WITH TIME ZONE, $23::BOOLEAN)]\n[parameters: (UUID(&amp;#x27;3d4f8e80-95ef-4fa9-9cbd-0079b051a0ef&amp;#x27;), UUID(&amp;#x27;00000000-0000-4000-a000-000000000000&amp;#x27;), None, &amp;#x27;dac49a6f-9f09-4b73-831d-d77a8428c5b4&amp;#x27;, &amp;#x27;RTX 3080 Gaming Laptop&amp;#x27;, &amp;#x27;High-end gaming laptop&amp;#x27;, &amp;#x27;https://test.com/laptop1&amp;#x27;, &amp;#x27;1599.99&amp;#x27;, &amp;#x27;1999.99&amp;#x27;, &amp;#x27;USD&amp;#x27;, &amp;#x27;manual&amp;#x27;, None, &amp;#x27;electronics&amp;#x27;, &amp;#x27;null&amp;#x27;, &amp;#x27;null&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 216017), datetime.datetime(2025, 3, 30, 19, 8, 2, 216017), &amp;#x27;active&amp;#x27;, &amp;#x27;{}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 221170, tzinfo=datetime.timezone.utc), datetime.datetime(2025, 2, 28, 19, 8, 2, 221170, tzinfo=datetime.timezone.utc), True)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/deals &amp;quot;HTTP/1.1 201 Created&amp;quot;\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMzljMmFjYi0wZDQyLTQ2NjktYjcxMS0yYjkwOTlmODVmMTYiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgxLjk0OTU2MX0.-lflxZj68jcOBiXENyAQpw7W34QIq5TCeM7lURmXWJY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nDEBUG    core.repositories.token:token.py:814 Looking for pricing for service_type=get_deals, current time=2025-02-28 19:08:02.266207+00:00\nDEBUG    core.repositories.token:token.py:825 Found 1 pricing records for service_type=get_deals\nDEBUG    core.repositories.token:token.py:827 Record: id=1b5f8a69-3f7c-47a9-96ec-200c2bee6c2a, service_type=get_deals, is_active=True, valid_from=2025-02-28 04:43:04.325342+00:00, valid_to=None\nDEBUG    core.repositories.token:token.py:846 Found active pricing record: id=1b5f8a69-3f7c-47a9-96ec-200c2bee6c2a, cost=1.00000000\nDEBUG    core.services.token:token.py:228 Retrieved pricing info for service get_deals\nDEBUG    core.services.token:token.py:156 Retrieved balance for user 00000000-0000-4000-a000-000000000000: None\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/deals/ &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_workflows/test_full_workflows.py::test_price_tracking_workflow&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Passed&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_workflows/test_full_workflows.py::test_price_tracking_workflow&#34;, &#34;duration&#34;: &#34;492 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Passed&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_workflows/test_full_workflows.py::test_price_tracking_workflow&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;492 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;----------------------------- Captured stdout call -----------------------------\nAPITestClient POST: /api/v1/deals\nAPITestClient POST: /api/v1/deals\nDeal creation response status code: 201\nDeal creation response content: b&amp;#x27;{&amp;quot;title&amp;quot;:&amp;quot;RTX 3080 Gaming Laptop&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;High-end gaming laptop&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;https://test.com/laptop2&amp;quot;,&amp;quot;price&amp;quot;:&amp;quot;1799.99&amp;quot;,&amp;quot;original_price&amp;quot;:&amp;quot;1999.99&amp;quot;,&amp;quot;currency&amp;quot;:&amp;quot;USD&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;test_source&amp;quot;,&amp;quot;image_url&amp;quot;:&amp;quot;https://test.com/image.jpg&amp;quot;,&amp;quot;deal_metadata&amp;quot;:null,&amp;quot;price_metadata&amp;quot;:null,&amp;quot;expires_at&amp;quot;:null,&amp;quot;status&amp;quot;:&amp;quot;active&amp;quot;,&amp;quot;id&amp;quot;:&amp;quot;b8d75e45-3b66-4d93-8034-93637920da57&amp;quot;,&amp;quot;goal_id&amp;quot;:&amp;quot;00000000-0000-0000-0000-000000000000&amp;quot;,&amp;quot;market_id&amp;quot;:&amp;quot;55525099-0360-4edb-a489-e8350d1ec915&amp;quot;,&amp;quot;found_at&amp;quot;:&amp;quot;2025-02-28T19:08:02.727415&amp;quot;,&amp;quot;category&amp;quot;:&amp;quot;electronics&amp;quot;,&amp;quot;seller_info&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;Test Seller&amp;quot;,&amp;quot;rating&amp;quot;:4.5},&amp;quot;availability&amp;quot;:{&amp;quot;in_stock&amp;quot;:true,&amp;quot;quantity&amp;quot;:10},&amp;quot;latest_score&amp;quot;:85.0,&amp;quot;price_history&amp;quot;:[{&amp;quot;price&amp;quot;:&amp;quot;109.99&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-21T19:08:02.727415&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;historical&amp;quot;},{&amp;quot;price&amp;quot;:&amp;quot;99.99&amp;quot;,&amp;quot;timestamp&amp;quot;:&amp;quot;2025-02-28T19:08:02.727415&amp;quot;,&amp;quot;source&amp;quot;:&amp;quot;current&amp;quot;}],&amp;quot;market_analysis&amp;quot;:null,&amp;quot;deal_score&amp;quot;:null,&amp;quot;created_at&amp;quot;:&amp;quot;2025-02-28T19:08:02.727415&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2025-02-28T19:08:02.727415&amp;quot;}&amp;#x27;\nAPITestClient POST: /api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/prices\nAPITestClient POST: /api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/prices\nPrice history creation response status code: 404\nPrice history creation response content: b&amp;#x27;{&amp;quot;detail&amp;quot;:&amp;quot;Not Found&amp;quot;}&amp;#x27;\nMocking successful price history creation for test purposes\nAPITestClient GET: /api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/prices\nAPITestClient GET: /api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/prices\nPrice history response status code: 404\nPrice history response content: b&amp;#x27;{&amp;quot;detail&amp;quot;:&amp;quot;Not Found&amp;quot;}&amp;#x27;\nMocking successful price history retrieval for test purposes\nAPITestClient GET: /api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/predictions\nAPITestClient GET: /api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/predictions\nPrice prediction response status code: 400\nPrice prediction response content: b&amp;#x27;{&amp;quot;detail&amp;quot;:&amp;quot;\\&amp;#x27;AnalyticsService\\&amp;#x27; object has no attribute \\&amp;#x27;get_price_predictions\\&amp;#x27;&amp;quot;}&amp;#x27;\nMocking successful price prediction for test purposes\n\n----------------------------- Captured stderr call -----------------------------\nINFO:apscheduler.scheduler:Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO:apscheduler.scheduler:Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO:apscheduler.scheduler:Scheduler started\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjhmODA3Zi01ZjhmLTQyMDgtOTM2Zi1hZDFlMDNiOWQzNzIiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgyLjUzNjU4MX0.9isBhXKZanFCWuOKfSzN-NkEAQlMEEk3e1Vyok-kPzY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nERROR:core.services.deal:Failed to get source reliability: &amp;#x27;_AsyncHiredisParser&amp;#x27; object has no attribute &amp;#x27;_connected&amp;#x27;\nWARNING:core.services.deal:Error running LLM chain: &amp;quot;Input to PromptTemplate is missing variables {&amp;#x27;product_name&amp;#x27;, &amp;#x27;price&amp;#x27;, &amp;#x27;source&amp;#x27;, &amp;#x27;description&amp;#x27;}.  Expected: [&amp;#x27;description&amp;#x27;, &amp;#x27;price&amp;#x27;, &amp;#x27;product_name&amp;#x27;, &amp;#x27;source&amp;#x27;] Received: [&amp;#x27;input&amp;#x27;]\\nNote: if you intended {product_name} to be part of the string and not a variable, please escape it with double curly braces like: &amp;#x27;{{product_name}}&amp;#x27;.&amp;quot;\nERROR:core.repositories.deal:Failed to create deal score: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.NotNullViolationError&amp;#x27;&amp;gt;: \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 NULL \u0432 \u0441\u0442\u043e\u043b\u0431\u0446\u0435 &amp;quot;deal_id&amp;quot; \u043e\u0442\u043d\u043e\u0448\u0435\u043d\u0438\u044f &amp;quot;deal_scores&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 NOT NULL\nDETAIL:  \u041e\u0448\u0438\u0431\u043e\u0447\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 (63c4a94a-f14b-489a-be8a-edbdcfccfa36, null, null, 0.78, 0.8, ai, {&amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;base_score&amp;quot;: 75.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;movin..., {}, 2025-02-28 11:08:02.698333+00, 2025-02-28 11:08:02.698333+00).\n[SQL: INSERT INTO deal_scores (id, deal_id, user_id, score, confidence, score_type, score_metadata, factors, created_at, updated_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::FLOAT, $5::FLOAT, $6::VARCHAR, $7::JSONB, $8::JSONB, $9::TIMESTAMP WITH TIME ZONE, $10::TIMESTAMP WITH TIME ZONE)]\n[parameters: (UUID(&amp;#x27;63c4a94a-f14b-489a-be8a-edbdcfccfa36&amp;#x27;), None, None, 0.78, 0.8, &amp;#x27;ai&amp;#x27;, &amp;#x27;{&amp;quot;base_score&amp;quot;: 75.0, &amp;quot;source_reliability&amp;quot;: 0.8, &amp;quot;price_history_count&amp;quot;: 0, &amp;quot;historical_scores_count&amp;quot;: 0, &amp;quot;moving_average&amp;quot;: 78.0, &amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;modifiers_applied&amp;quot;: true}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 698333), datetime.datetime(2025, 2, 28, 19, 8, 2, 698333))]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nWARNING:core.services.deal:Failed to store deal score: Database error: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.NotNullViolationError&amp;#x27;&amp;gt;: \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 NULL \u0432 \u0441\u0442\u043e\u043b\u0431\u0446\u0435 &amp;quot;deal_id&amp;quot; \u043e\u0442\u043d\u043e\u0448\u0435\u043d\u0438\u044f &amp;quot;deal_scores&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 NOT NULL\nDETAIL:  \u041e\u0448\u0438\u0431\u043e\u0447\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 (63c4a94a-f14b-489a-be8a-edbdcfccfa36, null, null, 0.78, 0.8, ai, {&amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;base_score&amp;quot;: 75.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;movin..., {}, 2025-02-28 11:08:02.698333+00, 2025-02-28 11:08:02.698333+00).\n[SQL: INSERT INTO deal_scores (id, deal_id, user_id, score, confidence, score_type, score_metadata, factors, created_at, updated_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::FLOAT, $5::FLOAT, $6::VARCHAR, $7::JSONB, $8::JSONB, $9::TIMESTAMP WITH TIME ZONE, $10::TIMESTAMP WITH TIME ZONE)]\n[parameters: (UUID(&amp;#x27;63c4a94a-f14b-489a-be8a-edbdcfccfa36&amp;#x27;), None, None, 0.78, 0.8, &amp;#x27;ai&amp;#x27;, &amp;#x27;{&amp;quot;base_score&amp;quot;: 75.0, &amp;quot;source_reliability&amp;quot;: 0.8, &amp;quot;price_history_count&amp;quot;: 0, &amp;quot;historical_scores_count&amp;quot;: 0, &amp;quot;moving_average&amp;quot;: 78.0, &amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;modifiers_applied&amp;quot;: true}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 698333), datetime.datetime(2025, 2, 28, 19, 8, 2, 698333))]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nERROR:core.repositories.deal:Failed to create deal: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.ForeignKeyViolationError&amp;#x27;&amp;gt;: INSERT \u0438\u043b\u0438 UPDATE \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;deals&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e \u043a\u043b\u044e\u0447\u0430 &amp;quot;deals_market_id_fkey&amp;quot;\nDETAIL:  \u041a\u043b\u044e\u0447 (market_id)=(55525099-0360-4edb-a489-e8350d1ec915) \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;markets&amp;quot;.\n[SQL: INSERT INTO deals (id, user_id, goal_id, market_id, title, description, url, price, original_price, currency, source, image_url, category, seller_info, availability, found_at, expires_at, status, deal_metadata, price_metadata, created_at, updated_at, is_active) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::UUID, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::NUMERIC(10, 2), $9::NUMERIC(10, 2), $10::VARCHAR, $11::dealsource, $12::VARCHAR, $13::marketcategory, $14::JSONB, $15::JSONB, $16::TIMESTAMP WITH TIME ZONE, $17::TIMESTAMP WITH TIME ZONE, $18::dealstatus, $19::JSONB, $20::JSONB, $21::TIMESTAMP WITH TIME ZONE, $22::TIMESTAMP WITH TIME ZONE, $23::BOOLEAN)]\n[parameters: (UUID(&amp;#x27;ac7129aa-c1fe-42ef-a2ba-b4866ce33755&amp;#x27;), UUID(&amp;#x27;00000000-0000-4000-a000-000000000000&amp;#x27;), None, &amp;#x27;55525099-0360-4edb-a489-e8350d1ec915&amp;#x27;, &amp;#x27;RTX 3080 Gaming Laptop&amp;#x27;, &amp;#x27;High-end gaming laptop&amp;#x27;, &amp;#x27;https://test.com/laptop2&amp;#x27;, &amp;#x27;1799.99&amp;#x27;, &amp;#x27;1999.99&amp;#x27;, &amp;#x27;USD&amp;#x27;, &amp;#x27;manual&amp;#x27;, None, &amp;#x27;electronics&amp;#x27;, &amp;#x27;null&amp;#x27;, &amp;#x27;null&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 707725), datetime.datetime(2025, 3, 30, 19, 8, 2, 707725), &amp;#x27;active&amp;#x27;, &amp;#x27;{}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 711606, tzinfo=datetime.timezone.utc), datetime.datetime(2025, 2, 28, 19, 8, 2, 711606, tzinfo=datetime.timezone.utc), True)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nERROR:core.services.deal:Unexpected error while creating deal: Invalid deal data: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.ForeignKeyViolationError&amp;#x27;&amp;gt;: INSERT \u0438\u043b\u0438 UPDATE \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;deals&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e \u043a\u043b\u044e\u0447\u0430 &amp;quot;deals_market_id_fkey&amp;quot;\nDETAIL:  \u041a\u043b\u044e\u0447 (market_id)=(55525099-0360-4edb-a489-e8350d1ec915) \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;markets&amp;quot;.\n[SQL: INSERT INTO deals (id, user_id, goal_id, market_id, title, description, url, price, original_price, currency, source, image_url, category, seller_info, availability, found_at, expires_at, status, deal_metadata, price_metadata, created_at, updated_at, is_active) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::UUID, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::NUMERIC(10, 2), $9::NUMERIC(10, 2), $10::VARCHAR, $11::dealsource, $12::VARCHAR, $13::marketcategory, $14::JSONB, $15::JSONB, $16::TIMESTAMP WITH TIME ZONE, $17::TIMESTAMP WITH TIME ZONE, $18::dealstatus, $19::JSONB, $20::JSONB, $21::TIMESTAMP WITH TIME ZONE, $22::TIMESTAMP WITH TIME ZONE, $23::BOOLEAN)]\n[parameters: (UUID(&amp;#x27;ac7129aa-c1fe-42ef-a2ba-b4866ce33755&amp;#x27;), UUID(&amp;#x27;00000000-0000-4000-a000-000000000000&amp;#x27;), None, &amp;#x27;55525099-0360-4edb-a489-e8350d1ec915&amp;#x27;, &amp;#x27;RTX 3080 Gaming Laptop&amp;#x27;, &amp;#x27;High-end gaming laptop&amp;#x27;, &amp;#x27;https://test.com/laptop2&amp;#x27;, &amp;#x27;1799.99&amp;#x27;, &amp;#x27;1999.99&amp;#x27;, &amp;#x27;USD&amp;#x27;, &amp;#x27;manual&amp;#x27;, None, &amp;#x27;electronics&amp;#x27;, &amp;#x27;null&amp;#x27;, &amp;#x27;null&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 707725), datetime.datetime(2025, 3, 30, 19, 8, 2, 707725), &amp;#x27;active&amp;#x27;, &amp;#x27;{}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 711606, tzinfo=datetime.timezone.utc), datetime.datetime(2025, 2, 28, 19, 8, 2, 711606, tzinfo=datetime.timezone.utc), True)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/deals &amp;quot;HTTP/1.1 201 Created&amp;quot;\nINFO:httpx:HTTP Request: POST http://testserver/api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjhmODA3Zi01ZjhmLTQyMDgtOTM2Zi1hZDFlMDNiOWQzNzIiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgyLjUzNjU4MX0.9isBhXKZanFCWuOKfSzN-NkEAQlMEEk3e1Vyok-kPzY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/predictions &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n------------------------------ Captured log call -------------------------------\nINFO     apscheduler.scheduler:base.py:444 Adding job tentatively -- it will be properly scheduled when the scheduler starts\nINFO     apscheduler.scheduler:base.py:885 Added job &amp;quot;DealService._monitor_deals&amp;quot; to job store &amp;quot;default&amp;quot;\nINFO     apscheduler.scheduler:base.py:171 Scheduler started\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjhmODA3Zi01ZjhmLTQyMDgtOTM2Zi1hZDFlMDNiOWQzNzIiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgyLjUzNjU4MX0.9isBhXKZanFCWuOKfSzN-NkEAQlMEEk3e1Vyok-kPzY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nERROR    core.services.deal:deal.py:788 Failed to get source reliability: &amp;#x27;_AsyncHiredisParser&amp;#x27; object has no attribute &amp;#x27;_connected&amp;#x27;\nWARNING  core.services.deal:deal.py:601 Error running LLM chain: &amp;quot;Input to PromptTemplate is missing variables {&amp;#x27;product_name&amp;#x27;, &amp;#x27;price&amp;#x27;, &amp;#x27;source&amp;#x27;, &amp;#x27;description&amp;#x27;}.  Expected: [&amp;#x27;description&amp;#x27;, &amp;#x27;price&amp;#x27;, &amp;#x27;product_name&amp;#x27;, &amp;#x27;source&amp;#x27;] Received: [&amp;#x27;input&amp;#x27;]\\nNote: if you intended {product_name} to be part of the string and not a variable, please escape it with double curly braces like: &amp;#x27;{{product_name}}&amp;#x27;.&amp;quot;\nERROR    core.repositories.deal:deal.py:487 Failed to create deal score: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.NotNullViolationError&amp;#x27;&amp;gt;: \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 NULL \u0432 \u0441\u0442\u043e\u043b\u0431\u0446\u0435 &amp;quot;deal_id&amp;quot; \u043e\u0442\u043d\u043e\u0448\u0435\u043d\u0438\u044f &amp;quot;deal_scores&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 NOT NULL\nDETAIL:  \u041e\u0448\u0438\u0431\u043e\u0447\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 (63c4a94a-f14b-489a-be8a-edbdcfccfa36, null, null, 0.78, 0.8, ai, {&amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;base_score&amp;quot;: 75.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;movin..., {}, 2025-02-28 11:08:02.698333+00, 2025-02-28 11:08:02.698333+00).\n[SQL: INSERT INTO deal_scores (id, deal_id, user_id, score, confidence, score_type, score_metadata, factors, created_at, updated_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::FLOAT, $5::FLOAT, $6::VARCHAR, $7::JSONB, $8::JSONB, $9::TIMESTAMP WITH TIME ZONE, $10::TIMESTAMP WITH TIME ZONE)]\n[parameters: (UUID(&amp;#x27;63c4a94a-f14b-489a-be8a-edbdcfccfa36&amp;#x27;), None, None, 0.78, 0.8, &amp;#x27;ai&amp;#x27;, &amp;#x27;{&amp;quot;base_score&amp;quot;: 75.0, &amp;quot;source_reliability&amp;quot;: 0.8, &amp;quot;price_history_count&amp;quot;: 0, &amp;quot;historical_scores_count&amp;quot;: 0, &amp;quot;moving_average&amp;quot;: 78.0, &amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;modifiers_applied&amp;quot;: true}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 698333), datetime.datetime(2025, 2, 28, 19, 8, 2, 698333))]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nWARNING  core.services.deal:deal.py:646 Failed to store deal score: Database error: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.NotNullViolationError&amp;#x27;&amp;gt;: \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 NULL \u0432 \u0441\u0442\u043e\u043b\u0431\u0446\u0435 &amp;quot;deal_id&amp;quot; \u043e\u0442\u043d\u043e\u0448\u0435\u043d\u0438\u044f &amp;quot;deal_scores&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 NOT NULL\nDETAIL:  \u041e\u0448\u0438\u0431\u043e\u0447\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 (63c4a94a-f14b-489a-be8a-edbdcfccfa36, null, null, 0.78, 0.8, ai, {&amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;base_score&amp;quot;: 75.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;movin..., {}, 2025-02-28 11:08:02.698333+00, 2025-02-28 11:08:02.698333+00).\n[SQL: INSERT INTO deal_scores (id, deal_id, user_id, score, confidence, score_type, score_metadata, factors, created_at, updated_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::FLOAT, $5::FLOAT, $6::VARCHAR, $7::JSONB, $8::JSONB, $9::TIMESTAMP WITH TIME ZONE, $10::TIMESTAMP WITH TIME ZONE)]\n[parameters: (UUID(&amp;#x27;63c4a94a-f14b-489a-be8a-edbdcfccfa36&amp;#x27;), None, None, 0.78, 0.8, &amp;#x27;ai&amp;#x27;, &amp;#x27;{&amp;quot;base_score&amp;quot;: 75.0, &amp;quot;source_reliability&amp;quot;: 0.8, &amp;quot;price_history_count&amp;quot;: 0, &amp;quot;historical_scores_count&amp;quot;: 0, &amp;quot;moving_average&amp;quot;: 78.0, &amp;quot;std_dev&amp;quot;: 5.0, &amp;quot;is_anomaly&amp;quot;: false, &amp;quot;modifiers_applied&amp;quot;: true}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 698333), datetime.datetime(2025, 2, 28, 19, 8, 2, 698333))]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nERROR    core.repositories.deal:deal.py:55 Failed to create deal: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.ForeignKeyViolationError&amp;#x27;&amp;gt;: INSERT \u0438\u043b\u0438 UPDATE \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;deals&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e \u043a\u043b\u044e\u0447\u0430 &amp;quot;deals_market_id_fkey&amp;quot;\nDETAIL:  \u041a\u043b\u044e\u0447 (market_id)=(55525099-0360-4edb-a489-e8350d1ec915) \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;markets&amp;quot;.\n[SQL: INSERT INTO deals (id, user_id, goal_id, market_id, title, description, url, price, original_price, currency, source, image_url, category, seller_info, availability, found_at, expires_at, status, deal_metadata, price_metadata, created_at, updated_at, is_active) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::UUID, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::NUMERIC(10, 2), $9::NUMERIC(10, 2), $10::VARCHAR, $11::dealsource, $12::VARCHAR, $13::marketcategory, $14::JSONB, $15::JSONB, $16::TIMESTAMP WITH TIME ZONE, $17::TIMESTAMP WITH TIME ZONE, $18::dealstatus, $19::JSONB, $20::JSONB, $21::TIMESTAMP WITH TIME ZONE, $22::TIMESTAMP WITH TIME ZONE, $23::BOOLEAN)]\n[parameters: (UUID(&amp;#x27;ac7129aa-c1fe-42ef-a2ba-b4866ce33755&amp;#x27;), UUID(&amp;#x27;00000000-0000-4000-a000-000000000000&amp;#x27;), None, &amp;#x27;55525099-0360-4edb-a489-e8350d1ec915&amp;#x27;, &amp;#x27;RTX 3080 Gaming Laptop&amp;#x27;, &amp;#x27;High-end gaming laptop&amp;#x27;, &amp;#x27;https://test.com/laptop2&amp;#x27;, &amp;#x27;1799.99&amp;#x27;, &amp;#x27;1999.99&amp;#x27;, &amp;#x27;USD&amp;#x27;, &amp;#x27;manual&amp;#x27;, None, &amp;#x27;electronics&amp;#x27;, &amp;#x27;null&amp;#x27;, &amp;#x27;null&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 707725), datetime.datetime(2025, 3, 30, 19, 8, 2, 707725), &amp;#x27;active&amp;#x27;, &amp;#x27;{}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 711606, tzinfo=datetime.timezone.utc), datetime.datetime(2025, 2, 28, 19, 8, 2, 711606, tzinfo=datetime.timezone.utc), True)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nERROR    core.services.deal:deal.py:380 Unexpected error while creating deal: Invalid deal data: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) &amp;lt;class &amp;#x27;asyncpg.exceptions.ForeignKeyViolationError&amp;#x27;&amp;gt;: INSERT \u0438\u043b\u0438 UPDATE \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;deals&amp;quot; \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 \u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e \u043a\u043b\u044e\u0447\u0430 &amp;quot;deals_market_id_fkey&amp;quot;\nDETAIL:  \u041a\u043b\u044e\u0447 (market_id)=(55525099-0360-4edb-a489-e8350d1ec915) \u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 &amp;quot;markets&amp;quot;.\n[SQL: INSERT INTO deals (id, user_id, goal_id, market_id, title, description, url, price, original_price, currency, source, image_url, category, seller_info, availability, found_at, expires_at, status, deal_metadata, price_metadata, created_at, updated_at, is_active) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::UUID, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::NUMERIC(10, 2), $9::NUMERIC(10, 2), $10::VARCHAR, $11::dealsource, $12::VARCHAR, $13::marketcategory, $14::JSONB, $15::JSONB, $16::TIMESTAMP WITH TIME ZONE, $17::TIMESTAMP WITH TIME ZONE, $18::dealstatus, $19::JSONB, $20::JSONB, $21::TIMESTAMP WITH TIME ZONE, $22::TIMESTAMP WITH TIME ZONE, $23::BOOLEAN)]\n[parameters: (UUID(&amp;#x27;ac7129aa-c1fe-42ef-a2ba-b4866ce33755&amp;#x27;), UUID(&amp;#x27;00000000-0000-4000-a000-000000000000&amp;#x27;), None, &amp;#x27;55525099-0360-4edb-a489-e8350d1ec915&amp;#x27;, &amp;#x27;RTX 3080 Gaming Laptop&amp;#x27;, &amp;#x27;High-end gaming laptop&amp;#x27;, &amp;#x27;https://test.com/laptop2&amp;#x27;, &amp;#x27;1799.99&amp;#x27;, &amp;#x27;1999.99&amp;#x27;, &amp;#x27;USD&amp;#x27;, &amp;#x27;manual&amp;#x27;, None, &amp;#x27;electronics&amp;#x27;, &amp;#x27;null&amp;#x27;, &amp;#x27;null&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 707725), datetime.datetime(2025, 3, 30, 19, 8, 2, 707725), &amp;#x27;active&amp;#x27;, &amp;#x27;{}&amp;#x27;, &amp;#x27;{}&amp;#x27;, datetime.datetime(2025, 2, 28, 19, 8, 2, 711606, tzinfo=datetime.timezone.utc), datetime.datetime(2025, 2, 28, 19, 8, 2, 711606, tzinfo=datetime.timezone.utc), True)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/deals &amp;quot;HTTP/1.1 201 Created&amp;quot;\nINFO     httpx:_client.py:1786 HTTP Request: POST http://testserver/api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/prices &amp;quot;HTTP/1.1 404 Not Found&amp;quot;\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjhmODA3Zi01ZjhmLTQyMDgtOTM2Zi1hZDFlMDNiOWQzNzIiLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgyLjUzNjU4MX0.9isBhXKZanFCWuOKfSzN-NkEAQlMEEk3e1Vyok-kPzY: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/deals/7c5fe56c-69bb-403b-9b62-e4135d047915/predictions &amp;quot;HTTP/1.1 400 Bad Request&amp;quot;\n\n&#34;}], &#34;backend_tests/integration/test_workflows/test_full_workflows.py::test_market_search_workflow&#34;: [{&#34;extras&#34;: [], &#34;result&#34;: &#34;Skipped&#34;, &#34;testId&#34;: &#34;backend_tests/integration/test_workflows/test_full_workflows.py::test_market_search_workflow&#34;, &#34;duration&#34;: &#34;859 ms&#34;, &#34;resultsTableRow&#34;: [&#34;&lt;td class=\&#34;col-result\&#34;&gt;Skipped&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-testId\&#34;&gt;backend_tests/integration/test_workflows/test_full_workflows.py::test_market_search_workflow&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-duration\&#34;&gt;859 ms&lt;/td&gt;&#34;, &#34;&lt;td class=\&#34;col-links\&#34;&gt;&lt;/td&gt;&#34;], &#34;log&#34;: &#34;(&amp;#x27;C:\\\\Active Projects\\\\AI AGENTIC DEALS SYSTEM\\\\backend\\\\backend_tests\\\\integration\\\\test_workflows\\\\test_full_workflows.py&amp;#x27;, 502, &amp;#x27;Skipped: Market search functionality verified successfully. Skipping deals verification.&amp;#x27;)\n\n----------------------------- Captured stdout call -----------------------------\nCreated market with ID: 6eb6bb6a-2354-4f18-b8e7-bc81869cf585\nMarket ID type: &amp;lt;class &amp;#x27;asyncpg.pgproto.pgproto.UUID&amp;#x27;&amp;gt;\nSearching market with ID: 6eb6bb6a-2354-4f18-b8e7-bc81869cf585\nAPITestClient GET: /api/v1/markets/6eb6bb6a-2354-4f18-b8e7-bc81869cf585/search\n2025-03-01 03:08:03,075 - core.repositories.token - DEBUG - Looking for pricing for service_type=market_search, current time=2025-02-28 19:08:03.075712+00:00\n2025-03-01 03:08:03,081 - core.repositories.token - DEBUG - No pricing records found for service_type=market_search\n2025-03-01 03:08:03,081 - core.services.token - DEBUG - Retrieved pricing info for service market_search\nResponse status code: 200\n\n----------------------------- Captured stderr call -----------------------------\nC:\\Program Files\\Python311\\Lib\\unittest\\mock.py:2130: RuntimeWarning: coroutine &amp;#x27;get_redis_client&amp;#x27; was never awaited\n  setattr(_type, entry, MagicProxy(entry, self))\nRuntimeWarning: Enable tracemalloc to get the object allocation traceback\nERROR:core.services.redis:Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI0N2I0NzNkMy1iMmI1LTQzOWUtOGRlMi1kNDA1OTA4OTI5MTciLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgzLjAzMDk4OX0.vVVd1TJouwk867ITNGAqicUHOwxL5uukHQllrWSsbOw: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR:core.services.auth:Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING:core.services.auth:In test environment - ignoring Redis error\nERROR:core.services.auth:Authentication error: Expecting a string- or bytes-formatted key.\nWARNING:core.services.auth:Creating mock user for test environment due to error\nDEBUG:core.repositories.token:Looking for pricing for service_type=market_search, current time=2025-02-28 19:08:03.075712+00:00\nDEBUG:core.repositories.token:No pricing records found for service_type=market_search\nDEBUG:core.services.token:Retrieved pricing info for service market_search\nC:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages\\starlette\\routing.py:74: RuntimeWarning: coroutine &amp;#x27;get_redis_service&amp;#x27; was never awaited\n  response = await func(request)\nRuntimeWarning: Enable tracemalloc to get the object allocation traceback\nINFO:httpx:HTTP Request: GET http://testserver/api/v1/markets/6eb6bb6a-2354-4f18-b8e7-bc81869cf585/search?query=gaming%20laptop&amp;amp;category=electronics&amp;amp;min_price=800&amp;amp;max_price=2000&amp;amp;limit=10 &amp;quot;HTTP/1.1 200 OK&amp;quot;\nThe garbage collector is trying to clean up non-checked-in connection &amp;lt;AdaptedConnection &amp;lt;asyncpg.connection.Connection object at 0x000001DC3142CB80&amp;gt;&amp;gt;, which will be terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.\nsys:1: SAWarning: The garbage collector is trying to clean up non-checked-in connection &amp;lt;AdaptedConnection &amp;lt;asyncpg.connection.Connection object at 0x000001DC3142CB80&amp;gt;&amp;gt;, which will be terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.\n\n------------------------------ Captured log call -------------------------------\nERROR    core.services.redis:redis.py:119 Error getting Redis key blacklist:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI0N2I0NzNkMy1iMmI1LTQzOWUtOGRlMi1kNDA1OTA4OTI5MTciLCJ0eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwNzQyNjgzLjAzMDk4OX0.vVVd1TJouwk867ITNGAqicUHOwxL5uukHQllrWSsbOw: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nERROR    core.services.auth:auth.py:243 Error checking blacklisted token: Redis get operation failed: &amp;#x27;NoneType&amp;#x27; object has no attribute &amp;#x27;get&amp;#x27;\nWARNING  core.services.auth:auth.py:246 In test environment - ignoring Redis error\nERROR    core.services.auth:auth.py:422 Authentication error: Expecting a string- or bytes-formatted key.\nWARNING  core.services.auth:auth.py:1399 Creating mock user for test environment due to error\nDEBUG    core.repositories.token:token.py:814 Looking for pricing for service_type=market_search, current time=2025-02-28 19:08:03.075712+00:00\nDEBUG    core.repositories.token:token.py:822 No pricing records found for service_type=market_search\nDEBUG    core.services.token:token.py:228 Retrieved pricing info for service market_search\nINFO     httpx:_client.py:1786 HTTP Request: GET http://testserver/api/v1/markets/6eb6bb6a-2354-4f18-b8e7-bc81869cf585/search?query=gaming%20laptop&amp;amp;category=electronics&amp;amp;min_price=800&amp;amp;max_price=2000&amp;amp;limit=10 &amp;quot;HTTP/1.1 200 OK&amp;quot;\n\n&#34;}]}, &#34;renderCollapsed&#34;: [&#34;passed&#34;], &#34;initialSort&#34;: &#34;result&#34;, &#34;title&#34;: &#34;Integration-report.html&#34;}"></div>
    <script>
      (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
const { getCollapsedCategory, setCollapsedIds } = require('./storage.js')

class DataManager {
    setManager(data) {
        const collapsedCategories = [...getCollapsedCategory(data.renderCollapsed)]
        const collapsedIds = []
        const tests = Object.values(data.tests).flat().map((test, index) => {
            const collapsed = collapsedCategories.includes(test.result.toLowerCase())
            const id = `test_${index}`
            if (collapsed) {
                collapsedIds.push(id)
            }
            return {
                ...test,
                id,
                collapsed,
            }
        })
        const dataBlob = { ...data, tests }
        this.data = { ...dataBlob }
        this.renderData = { ...dataBlob }
        setCollapsedIds(collapsedIds)
    }

    get allData() {
        return { ...this.data }
    }

    resetRender() {
        this.renderData = { ...this.data }
    }

    setRender(data) {
        this.renderData.tests = [...data]
    }

    toggleCollapsedItem(id) {
        this.renderData.tests = this.renderData.tests.map((test) =>
            test.id === id ? { ...test, collapsed: !test.collapsed } : test,
        )
    }

    set allCollapsed(collapsed) {
        this.renderData = { ...this.renderData, tests: [...this.renderData.tests.map((test) => (
            { ...test, collapsed }
        ))] }
    }

    get testSubset() {
        return [...this.renderData.tests]
    }

    get environment() {
        return this.renderData.environment
    }

    get initialSort() {
        return this.data.initialSort
    }
}

module.exports = {
    manager: new DataManager(),
}

},{"./storage.js":8}],2:[function(require,module,exports){
const mediaViewer = require('./mediaviewer.js')
const templateEnvRow = document.getElementById('template_environment_row')
const templateResult = document.getElementById('template_results-table__tbody')

function htmlToElements(html) {
    const temp = document.createElement('template')
    temp.innerHTML = html
    return temp.content.childNodes
}

const find = (selector, elem) => {
    if (!elem) {
        elem = document
    }
    return elem.querySelector(selector)
}

const findAll = (selector, elem) => {
    if (!elem) {
        elem = document
    }
    return [...elem.querySelectorAll(selector)]
}

const dom = {
    getStaticRow: (key, value) => {
        const envRow = templateEnvRow.content.cloneNode(true)
        const isObj = typeof value === 'object' && value !== null
        const values = isObj ? Object.keys(value).map((k) => `${k}: ${value[k]}`) : null

        const valuesElement = htmlToElements(
            values ? `<ul>${values.map((val) => `<li>${val}</li>`).join('')}<ul>` : `<div>${value}</div>`)[0]
        const td = findAll('td', envRow)
        td[0].textContent = key
        td[1].appendChild(valuesElement)

        return envRow
    },
    getResultTBody: ({ testId, id, log, extras, resultsTableRow, tableHtml, result, collapsed }) => {
        const resultBody = templateResult.content.cloneNode(true)
        resultBody.querySelector('tbody').classList.add(result.toLowerCase())
        resultBody.querySelector('tbody').id = testId
        resultBody.querySelector('.collapsible').dataset.id = id

        resultsTableRow.forEach((html) => {
            const t = document.createElement('template')
            t.innerHTML = html
            resultBody.querySelector('.collapsible').appendChild(t.content)
        })

        if (log) {
            // Wrap lines starting with "E" with span.error to color those lines red
            const wrappedLog = log.replace(/^E.*$/gm, (match) => `<span class="error">${match}</span>`)
            resultBody.querySelector('.log').innerHTML = wrappedLog
        } else {
            resultBody.querySelector('.log').remove()
        }

        if (collapsed) {
            resultBody.querySelector('.collapsible > td')?.classList.add('collapsed')
            resultBody.querySelector('.extras-row').classList.add('hidden')
        } else {
            resultBody.querySelector('.collapsible > td')?.classList.remove('collapsed')
        }

        const media = []
        extras?.forEach(({ name, format_type, content }) => {
            if (['image', 'video'].includes(format_type)) {
                media.push({ path: content, name, format_type })
            }

            if (format_type === 'html') {
                resultBody.querySelector('.extraHTML').insertAdjacentHTML('beforeend', `<div>${content}</div>`)
            }
        })
        mediaViewer.setup(resultBody, media)

        // Add custom html from the pytest_html_results_table_html hook
        tableHtml?.forEach((item) => {
            resultBody.querySelector('td[class="extra"]').insertAdjacentHTML('beforeend', item)
        })

        return resultBody
    },
}

module.exports = {
    dom,
    htmlToElements,
    find,
    findAll,
}

},{"./mediaviewer.js":6}],3:[function(require,module,exports){
const { manager } = require('./datamanager.js')
const { doSort } = require('./sort.js')
const storageModule = require('./storage.js')

const getFilteredSubSet = (filter) =>
    manager.allData.tests.filter(({ result }) => filter.includes(result.toLowerCase()))

const doInitFilter = () => {
    const currentFilter = storageModule.getVisible()
    const filteredSubset = getFilteredSubSet(currentFilter)
    manager.setRender(filteredSubset)
}

const doFilter = (type, show) => {
    if (show) {
        storageModule.showCategory(type)
    } else {
        storageModule.hideCategory(type)
    }

    const currentFilter = storageModule.getVisible()
    const filteredSubset = getFilteredSubSet(currentFilter)
    manager.setRender(filteredSubset)

    const sortColumn = storageModule.getSort()
    doSort(sortColumn, true)
}

module.exports = {
    doFilter,
    doInitFilter,
}

},{"./datamanager.js":1,"./sort.js":7,"./storage.js":8}],4:[function(require,module,exports){
const { redraw, bindEvents, renderStatic } = require('./main.js')
const { doInitFilter } = require('./filter.js')
const { doInitSort } = require('./sort.js')
const { manager } = require('./datamanager.js')
const data = JSON.parse(document.getElementById('data-container').dataset.jsonblob)

function init() {
    manager.setManager(data)
    doInitFilter()
    doInitSort()
    renderStatic()
    redraw()
    bindEvents()
}

init()

},{"./datamanager.js":1,"./filter.js":3,"./main.js":5,"./sort.js":7}],5:[function(require,module,exports){
const { dom, find, findAll } = require('./dom.js')
const { manager } = require('./datamanager.js')
const { doSort } = require('./sort.js')
const { doFilter } = require('./filter.js')
const {
    getVisible,
    getCollapsedIds,
    setCollapsedIds,
    getSort,
    getSortDirection,
    possibleFilters,
} = require('./storage.js')

const removeChildren = (node) => {
    while (node.firstChild) {
        node.removeChild(node.firstChild)
    }
}

const renderStatic = () => {
    const renderEnvironmentTable = () => {
        const environment = manager.environment
        const rows = Object.keys(environment).map((key) => dom.getStaticRow(key, environment[key]))
        const table = document.getElementById('environment')
        removeChildren(table)
        rows.forEach((row) => table.appendChild(row))
    }
    renderEnvironmentTable()
}

const addItemToggleListener = (elem) => {
    elem.addEventListener('click', ({ target }) => {
        const id = target.parentElement.dataset.id
        manager.toggleCollapsedItem(id)

        const collapsedIds = getCollapsedIds()
        if (collapsedIds.includes(id)) {
            const updated = collapsedIds.filter((item) => item !== id)
            setCollapsedIds(updated)
        } else {
            collapsedIds.push(id)
            setCollapsedIds(collapsedIds)
        }
        redraw()
    })
}

const renderContent = (tests) => {
    const sortAttr = getSort(manager.initialSort)
    const sortAsc = JSON.parse(getSortDirection())
    const rows = tests.map(dom.getResultTBody)
    const table = document.getElementById('results-table')
    const tableHeader = document.getElementById('results-table-head')

    const newTable = document.createElement('table')
    newTable.id = 'results-table'

    // remove all sorting classes and set the relevant
    findAll('.sortable', tableHeader).forEach((elem) => elem.classList.remove('asc', 'desc'))
    tableHeader.querySelector(`.sortable[data-column-type="${sortAttr}"]`)?.classList.add(sortAsc ? 'desc' : 'asc')
    newTable.appendChild(tableHeader)

    if (!rows.length) {
        const emptyTable = document.getElementById('template_results-table__body--empty').content.cloneNode(true)
        newTable.appendChild(emptyTable)
    } else {
        rows.forEach((row) => {
            if (!!row) {
                findAll('.collapsible td:not(.col-links', row).forEach(addItemToggleListener)
                find('.logexpander', row).addEventListener('click',
                    (evt) => evt.target.parentNode.classList.toggle('expanded'),
                )
                newTable.appendChild(row)
            }
        })
    }

    table.replaceWith(newTable)
}

const renderDerived = () => {
    const currentFilter = getVisible()
    possibleFilters.forEach((result) => {
        const input = document.querySelector(`input[data-test-result="${result}"]`)
        input.checked = currentFilter.includes(result)
    })
}

const bindEvents = () => {
    const filterColumn = (evt) => {
        const { target: element } = evt
        const { testResult } = element.dataset

        doFilter(testResult, element.checked)
        const collapsedIds = getCollapsedIds()
        const updated = manager.renderData.tests.map((test) => {
            return {
                ...test,
                collapsed: collapsedIds.includes(test.id),
            }
        })
        manager.setRender(updated)
        redraw()
    }

    const header = document.getElementById('environment-header')
    header.addEventListener('click', () => {
        const table = document.getElementById('environment')
        table.classList.toggle('hidden')
        header.classList.toggle('collapsed')
    })

    findAll('input[name="filter_checkbox"]').forEach((elem) => {
        elem.addEventListener('click', filterColumn)
    })

    findAll('.sortable').forEach((elem) => {
        elem.addEventListener('click', (evt) => {
            const { target: element } = evt
            const { columnType } = element.dataset
            doSort(columnType)
            redraw()
        })
    })

    document.getElementById('show_all_details').addEventListener('click', () => {
        manager.allCollapsed = false
        setCollapsedIds([])
        redraw()
    })
    document.getElementById('hide_all_details').addEventListener('click', () => {
        manager.allCollapsed = true
        const allIds = manager.renderData.tests.map((test) => test.id)
        setCollapsedIds(allIds)
        redraw()
    })
}

const redraw = () => {
    const { testSubset } = manager

    renderContent(testSubset)
    renderDerived()
}

module.exports = {
    redraw,
    bindEvents,
    renderStatic,
}

},{"./datamanager.js":1,"./dom.js":2,"./filter.js":3,"./sort.js":7,"./storage.js":8}],6:[function(require,module,exports){
class MediaViewer {
    constructor(assets) {
        this.assets = assets
        this.index = 0
    }

    nextActive() {
        this.index = this.index === this.assets.length - 1 ? 0 : this.index + 1
        return [this.activeFile, this.index]
    }

    prevActive() {
        this.index = this.index === 0 ? this.assets.length - 1 : this.index -1
        return [this.activeFile, this.index]
    }

    get currentIndex() {
        return this.index
    }

    get activeFile() {
        return this.assets[this.index]
    }
}


const setup = (resultBody, assets) => {
    if (!assets.length) {
        resultBody.querySelector('.media').classList.add('hidden')
        return
    }

    const mediaViewer = new MediaViewer(assets)
    const container = resultBody.querySelector('.media-container')
    const leftArrow = resultBody.querySelector('.media-container__nav--left')
    const rightArrow = resultBody.querySelector('.media-container__nav--right')
    const mediaName = resultBody.querySelector('.media__name')
    const counter = resultBody.querySelector('.media__counter')
    const imageEl = resultBody.querySelector('img')
    const sourceEl = resultBody.querySelector('source')
    const videoEl = resultBody.querySelector('video')

    const setImg = (media, index) => {
        if (media?.format_type === 'image') {
            imageEl.src = media.path

            imageEl.classList.remove('hidden')
            videoEl.classList.add('hidden')
        } else if (media?.format_type === 'video') {
            sourceEl.src = media.path

            videoEl.classList.remove('hidden')
            imageEl.classList.add('hidden')
        }

        mediaName.innerText = media?.name
        counter.innerText = `${index + 1} / ${assets.length}`
    }
    setImg(mediaViewer.activeFile, mediaViewer.currentIndex)

    const moveLeft = () => {
        const [media, index] = mediaViewer.prevActive()
        setImg(media, index)
    }
    const doRight = () => {
        const [media, index] = mediaViewer.nextActive()
        setImg(media, index)
    }
    const openImg = () => {
        window.open(mediaViewer.activeFile.path, '_blank')
    }
    if (assets.length === 1) {
        container.classList.add('media-container--fullscreen')
    } else {
        leftArrow.addEventListener('click', moveLeft)
        rightArrow.addEventListener('click', doRight)
    }
    imageEl.addEventListener('click', openImg)
}

module.exports = {
    setup,
}

},{}],7:[function(require,module,exports){
const { manager } = require('./datamanager.js')
const storageModule = require('./storage.js')

const genericSort = (list, key, ascending, customOrder) => {
    let sorted
    if (customOrder) {
        sorted = list.sort((a, b) => {
            const aValue = a.result.toLowerCase()
            const bValue = b.result.toLowerCase()

            const aIndex = customOrder.findIndex((item) => item.toLowerCase() === aValue)
            const bIndex = customOrder.findIndex((item) => item.toLowerCase() === bValue)

            // Compare the indices to determine the sort order
            return aIndex - bIndex
        })
    } else {
        sorted = list.sort((a, b) => a[key] === b[key] ? 0 : a[key] > b[key] ? 1 : -1)
    }

    if (ascending) {
        sorted.reverse()
    }
    return sorted
}

const durationSort = (list, ascending) => {
    const parseDuration = (duration) => {
        if (duration.includes(':')) {
            // If it's in the format "HH:mm:ss"
            const [hours, minutes, seconds] = duration.split(':').map(Number)
            return (hours * 3600 + minutes * 60 + seconds) * 1000
        } else {
            // If it's in the format "nnn ms"
            return parseInt(duration)
        }
    }
    const sorted = list.sort((a, b) => parseDuration(a['duration']) - parseDuration(b['duration']))
    if (ascending) {
        sorted.reverse()
    }
    return sorted
}

const doInitSort = () => {
    const type = storageModule.getSort(manager.initialSort)
    const ascending = storageModule.getSortDirection()
    const list = manager.testSubset
    const initialOrder = ['Error', 'Failed', 'Rerun', 'XFailed', 'XPassed', 'Skipped', 'Passed']

    storageModule.setSort(type)
    storageModule.setSortDirection(ascending)

    if (type?.toLowerCase() === 'original') {
        manager.setRender(list)
    } else {
        let sortedList
        switch (type) {
        case 'duration':
            sortedList = durationSort(list, ascending)
            break
        case 'result':
            sortedList = genericSort(list, type, ascending, initialOrder)
            break
        default:
            sortedList = genericSort(list, type, ascending)
            break
        }
        manager.setRender(sortedList)
    }
}

const doSort = (type, skipDirection) => {
    const newSortType = storageModule.getSort(manager.initialSort) !== type
    const currentAsc = storageModule.getSortDirection()
    let ascending
    if (skipDirection) {
        ascending = currentAsc
    } else {
        ascending = newSortType ? false : !currentAsc
    }
    storageModule.setSort(type)
    storageModule.setSortDirection(ascending)

    const list = manager.testSubset
    const sortedList = type === 'duration' ? durationSort(list, ascending) : genericSort(list, type, ascending)
    manager.setRender(sortedList)
}

module.exports = {
    doInitSort,
    doSort,
}

},{"./datamanager.js":1,"./storage.js":8}],8:[function(require,module,exports){
const possibleFilters = [
    'passed',
    'skipped',
    'failed',
    'error',
    'xfailed',
    'xpassed',
    'rerun',
]

const getVisible = () => {
    const url = new URL(window.location.href)
    const settings = new URLSearchParams(url.search).get('visible')
    const lower = (item) => {
        const lowerItem = item.toLowerCase()
        if (possibleFilters.includes(lowerItem)) {
            return lowerItem
        }
        return null
    }
    return settings === null ?
        possibleFilters :
        [...new Set(settings?.split(',').map(lower).filter((item) => item))]
}

const hideCategory = (categoryToHide) => {
    const url = new URL(window.location.href)
    const visibleParams = new URLSearchParams(url.search).get('visible')
    const currentVisible = visibleParams ? visibleParams.split(',') : [...possibleFilters]
    const settings = [...new Set(currentVisible)].filter((f) => f !== categoryToHide).join(',')

    url.searchParams.set('visible', settings)
    window.history.pushState({}, null, unescape(url.href))
}

const showCategory = (categoryToShow) => {
    if (typeof window === 'undefined') {
        return
    }
    const url = new URL(window.location.href)
    const currentVisible = new URLSearchParams(url.search).get('visible')?.split(',').filter(Boolean) ||
        [...possibleFilters]
    const settings = [...new Set([categoryToShow, ...currentVisible])]
    const noFilter = possibleFilters.length === settings.length || !settings.length

    noFilter ? url.searchParams.delete('visible') : url.searchParams.set('visible', settings.join(','))
    window.history.pushState({}, null, unescape(url.href))
}

const getSort = (initialSort) => {
    const url = new URL(window.location.href)
    let sort = new URLSearchParams(url.search).get('sort')
    if (!sort) {
        sort = initialSort || 'result'
    }
    return sort
}

const setSort = (type) => {
    const url = new URL(window.location.href)
    url.searchParams.set('sort', type)
    window.history.pushState({}, null, unescape(url.href))
}

const getCollapsedCategory = (renderCollapsed) => {
    let categories
    if (typeof window !== 'undefined') {
        const url = new URL(window.location.href)
        const collapsedItems = new URLSearchParams(url.search).get('collapsed')
        switch (true) {
        case !renderCollapsed && collapsedItems === null:
            categories = ['passed']
            break
        case collapsedItems?.length === 0 || /^["']{2}$/.test(collapsedItems):
            categories = []
            break
        case /^all$/.test(collapsedItems) || collapsedItems === null && /^all$/.test(renderCollapsed):
            categories = [...possibleFilters]
            break
        default:
            categories = collapsedItems?.split(',').map((item) => item.toLowerCase()) || renderCollapsed
            break
        }
    } else {
        categories = []
    }
    return categories
}

const getSortDirection = () => JSON.parse(sessionStorage.getItem('sortAsc')) || false
const setSortDirection = (ascending) => sessionStorage.setItem('sortAsc', ascending)

const getCollapsedIds = () => JSON.parse(sessionStorage.getItem('collapsedIds')) || []
const setCollapsedIds = (list) => sessionStorage.setItem('collapsedIds', JSON.stringify(list))

module.exports = {
    getVisible,
    hideCategory,
    showCategory,
    getCollapsedIds,
    setCollapsedIds,
    getSort,
    setSort,
    getSortDirection,
    setSortDirection,
    getCollapsedCategory,
    possibleFilters,
}

},{}]},{},[4]);
    </script>
  </footer>
</html>