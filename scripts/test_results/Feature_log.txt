Starting tests at 2025-03-05 00:27:58.132941
Python path: ['C:\\Users\\GLuK Laptop\\AppData\\Local\\Temp', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend', 'C:\\Program Files\\Python311\\python311.zip', 'C:\\Program Files\\Python311\\DLLs', 'C:\\Program Files\\Python311\\Lib', 'C:\\Program Files\\Python311', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages\\win32', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages\\win32\\lib', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages\\Pythonwin']
DEBUG: Environment variables in settings.py:
DEBUG: host: localhost
DEBUG: hosts: ["localhost"]
DEBUG: REDIS_HOST: localhost
DEBUG: REDIS_URL: redis://localhost:6379/0
DEBUG: REDIS_PASSWORD: 
DEBUG: In build_redis_url validator
DEBUG: In build_redis_url: Removed 'host' to avoid Redis validation error
DEBUG: In build_database_url validator
DEBUG: Using default host: deals_postgres
DEBUG: Building URL with HOST=deals_postgres, PORT=5432, USER=postgres, DB=agentic_deals
DEBUG: Using asyncpg driver for normal operation
DEBUG: Built DATABASE_URL with host=deals_postgres, port=5432
Import error while patching database connection: cannot import name 'get_settings' from 'core.config.settings' (C:\Active Projects\AI AGENTIC DEALS SYSTEM\backend\core\config\settings.py)
Python path: ['C:\\Users\\GLuK Laptop\\AppData\\Local\\Temp', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend', 'C:\\Program Files\\Python311\\python311.zip', 'C:\\Program Files\\Python311\\DLLs', 'C:\\Program Files\\Python311\\Lib', 'C:\\Program Files\\Python311', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages\\win32', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages\\win32\\lib', 'C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\venv\\Lib\\site-packages\\Pythonwin']
Successfully imported db_connection_patch
Loading patch settings from: C:\Active Projects\AI AGENTIC DEALS SYSTEM\backend\patch_settings.py
Loading test environment from: C:\Active Projects\AI AGENTIC DEALS SYSTEM\backend\.env.test
Environment variables set for testing
Settings module patched successfully
Fixing the Base class registry issue...

Registered tables in DatabaseBase.metadata:

Registered tables in ModelsBase.metadata:
  - agents
  - auth_tokens
  - chat_contexts
  - chat_messages
  - chats
  - deal_interactions
  - deal_matches
  - deal_scores
  - deal_tokens
  - deals
  - goals
  - markets
  - model_metrics
  - notifications
  - price_histories
  - price_points
  - price_predictions
  - price_trackers
  - token_balance_history
  - token_balances
  - token_prices
  - token_pricing
  - token_transactions
  - token_wallets
  - tokens
  - tracked_deals
  - user_preferences
  - users
  - wallet_transactions

The 'agents' table is not registered with DatabaseBase.metadata
Fixing by copying model metadata from ModelsBase to DatabaseBase...
  - Added auth_tokens to DatabaseBase.metadata
  - Added deal_tokens to DatabaseBase.metadata
  - Added price_histories to DatabaseBase.metadata
  - Added deals to DatabaseBase.metadata
  - Added price_points to DatabaseBase.metadata
  - Added price_trackers to DatabaseBase.metadata
  - Added token_transactions to DatabaseBase.metadata
  - Added token_balance_history to DatabaseBase.metadata
  - Added token_wallets to DatabaseBase.metadata
  - Added wallet_transactions to DatabaseBase.metadata
  - Added token_balances to DatabaseBase.metadata
  - Added tokens to DatabaseBase.metadata
  - Added token_prices to DatabaseBase.metadata
  - Added chat_contexts to DatabaseBase.metadata
  - Added notifications to DatabaseBase.metadata
  - Added user_preferences to DatabaseBase.metadata
  - Added users to DatabaseBase.metadata
  - Added price_predictions to DatabaseBase.metadata
  - Added model_metrics to DatabaseBase.metadata
  - Added markets to DatabaseBase.metadata
  - Added goals to DatabaseBase.metadata
  - Added token_pricing to DatabaseBase.metadata
  - Added deal_matches to DatabaseBase.metadata
  - Added deal_scores to DatabaseBase.metadata
  - Added chats to DatabaseBase.metadata
  - Added chat_messages to DatabaseBase.metadata
  - Added deal_interactions to DatabaseBase.metadata
  - Added tracked_deals to DatabaseBase.metadata
  - Added agents to DatabaseBase.metadata

Verification: 'agents' table is now registered with DatabaseBase.metadata

Updated tables in DatabaseBase.metadata:
  - agents
  - auth_tokens
  - chat_contexts
  - chat_messages
  - chats
  - deal_interactions
  - deal_matches
  - deal_scores
  - deal_tokens
  - deals
  - goals
  - markets
  - model_metrics
  - notifications
  - price_histories
  - price_points
  - price_predictions
  - price_trackers
  - token_balance_history
  - token_balances
  - token_prices
  - token_pricing
  - token_transactions
  - token_wallets
  - tokens
  - tracked_deals
  - user_preferences
  - users
  - wallet_transactions

Verification: 'chat_contexts' table is now registered with DatabaseBase.metadata

Base class registry issues should now be fixed.
Successfully imported DatabaseBase
Registered tables in DatabaseBase.metadata:
  - agents
  - auth_tokens
  - chat_contexts
  - chat_messages
  - chats
  - deal_interactions
  - deal_matches
  - deal_scores
  - deal_tokens
  - deals
  - goals
  - markets
  - model_metrics
  - notifications
  - price_histories
  - price_points
  - price_predictions
  - price_trackers
  - token_balance_history
  - token_balances
  - token_prices
  - token_pricing
  - token_transactions
  - token_wallets
  - tokens
  - tracked_deals
  - user_preferences
  - users
  - wallet_transactions
Running tests from: C:\Active Projects\AI AGENTIC DEALS SYSTEM\backend\backend_tests
Test marker: feature
Report will be saved to: C:\Active Projects\AI AGENTIC DEALS SYSTEM\backend\scripts\test_results\Feature_report.html
Running pytest with args: ['C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\backend_tests', '-v', '-m', 'feature', '--html=C:\\Active Projects\\AI AGENTIC DEALS SYSTEM\\backend\\scripts\\test_results\\Feature_report.html', '--self-contained-html', '--timeout=60', '-xvs']
DEBUG: Environment variables in settings.py:
DEBUG: host: localhost
DEBUG: hosts: ["localhost"]
DEBUG: REDIS_HOST: localhost
DEBUG: REDIS_URL: redis://localhost:6379/0
DEBUG: REDIS_PASSWORD: 
DEBUG: In build_redis_url validator
DEBUG: In build_redis_url: Removed 'host' to avoid Redis validation error
DEBUG: In build_database_url validator
DEBUG: Building URL with HOST=localhost, PORT=5432, USER=postgres, DB=deals_test
DEBUG: Using asyncpg driver for normal operation
DEBUG: Built DATABASE_URL with host=localhost, port=5432
Loading test environment from: C:\Active Projects\AI AGENTIC DEALS SYSTEM\.env.test
Environment variables set for testing
Settings module patched successfully
Loading test environment from: C:\Active Projects\AI AGENTIC DEALS SYSTEM\backend\.env.test
DEBUG: Environment variables in settings.py:
DEBUG: host: localhost
DEBUG: hosts: ["localhost"]
DEBUG: REDIS_HOST: localhost
DEBUG: REDIS_URL: redis://localhost:6379/0
DEBUG: REDIS_PASSWORD: 
DEBUG: In build_redis_url validator
DEBUG: In build_redis_url: Removed 'host' to avoid Redis validation error
DEBUG: In build_database_url validator
DEBUG: Building URL with HOST=localhost, PORT=5432, USER=postgres, DB=deals_test
DEBUG: Using asyncpg driver for normal operation
DEBUG: Built DATABASE_URL with host=localhost, port=5432
ERROR:prophet.plot:Importing plotly failed. Interactive plots will not work.
Loading test environment from: C:\Active Projects\AI AGENTIC DEALS SYSTEM\backend\.env.test
[1m============================= test session starts =============================[0m
platform win32 -- Python 3.11.4, pytest-7.4.4, pluggy-1.5.0 -- C:\Active Projects\AI AGENTIC DEALS SYSTEM\venv\Scripts\python.exe
cachedir: .pytest_cache
metadata: {'Python': '3.11.4', 'Platform': 'Windows-10-10.0.22631-SP0', 'Packages': {'pytest': '7.4.4', 'pluggy': '1.5.0'}, 'Plugins': {'anchorpy': '0.18.0', 'anyio': '3.7.1', 'Faker': '22.5.1', 'asyncio': '0.21.1', 'cov': '4.1.0', 'html': '4.1.1', 'metadata': '3.1.1', 'mock': '3.12.0', 'timeout': '2.3.1', 'xdist': '3.6.1', 'xprocess': '0.18.1', 'time-machine': '2.16.0'}}
rootdir: C:\Active Projects\AI AGENTIC DEALS SYSTEM\backend
configfile: pytest.ini
plugins: anchorpy-0.18.0, anyio-3.7.1, Faker-22.5.1, asyncio-0.21.1, cov-4.1.0, html-4.1.1, metadata-3.1.1, mock-3.12.0, timeout-2.3.1, xdist-3.6.1, xprocess-0.18.1, time-machine-2.16.0
asyncio: mode=Mode.AUTO
timeout: 60.0s
timeout method: thread
timeout func_only: False
[1mcollecting ... [0mDEBUG: Environment variables in settings.py:
DEBUG: host: localhost
DEBUG: hosts: ["localhost"]
DEBUG: REDIS_HOST: localhost
DEBUG: REDIS_URL: redis://localhost:6379/0
DEBUG: REDIS_PASSWORD: 
DEBUG: In build_redis_url validator
DEBUG: In build_redis_url: Removed 'host' to avoid Redis validation error
DEBUG: In build_database_url validator
DEBUG: Building URL with HOST=localhost, PORT=5432, USER=postgres, DB=deals_test
DEBUG: Using asyncpg driver for normal operation
DEBUG: Built DATABASE_URL with host=localhost, port=5432
collected 324 items / 296 deselected / 28 selected

INFO:backend.backend_tests.features.conftest:Redis mock initialized for feature test
..\..\..\backend_tests\features\test_agents\test_agent_factory.py::test_agent_factory_initialization 
[1m------------------------------- live log setup --------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Redis mock initialized for feature test (conftest.py:43)
INFO:core.services.llm_service:Initialized LLM service with provider: deepseek-r1, model: deepseek-r1
[1m-------------------------------- live log call --------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Initialized LLM service with provider: deepseek-r1, model: deepseek-r1 (llm_service.py:138)
INFO:backend.backend_tests.features.conftest:Redis mock cleaned up after feature test
[32mPASSED[0m
[1m------------------------------ live log teardown ------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Redis mock cleaned up after feature test (conftest.py:48)

C:\Program Files\Python311\Lib\unittest\mock.py:2130: RuntimeWarning: coroutine 'get_mock_redis_service' was never awaited
  setattr(_type, entry, MagicProxy(entry, self))
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
INFO:backend.backend_tests.features.conftest:Redis mock initialized for feature test
..\..\..\backend_tests\features\test_agents\test_agent_factory.py::test_get_agent_factory 
[1m------------------------------- live log setup --------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Redis mock initialized for feature test (conftest.py:43)
INFO:backend.backend_tests.features.conftest:Redis mock cleaned up after feature test
[32mPASSED[0m
[1m------------------------------ live log teardown ------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Redis mock cleaned up after feature test (conftest.py:48)

INFO:backend.backend_tests.features.conftest:Redis mock initialized for feature test
..\..\..\backend_tests\features\test_agents\test_agent_factory.py::test_create_agent 
[1m------------------------------- live log setup --------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Redis mock initialized for feature test (conftest.py:43)
INFO:core.agents.market_analyst_agent:Setting up MarketAnalystAgent
[1m-------------------------------- live log call --------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Setting up MarketAnalystAgent (market_analyst_agent.py:41)
INFO:core.agents.market_analyst_agent:Setting up MarketAnalystAgent
2025-03-05 00:28:07 [[32m    INFO[0m] Setting up MarketAnalystAgent (market_analyst_agent.py:41)
INFO:core.agents.market_analyst_agent:Setting up MarketAnalystAgent
2025-03-05 00:28:07 [[32m    INFO[0m] Setting up MarketAnalystAgent (market_analyst_agent.py:41)
INFO:backend.backend_tests.features.conftest:Redis mock cleaned up after feature test
[32mPASSED[0m
[1m------------------------------ live log teardown ------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Redis mock cleaned up after feature test (conftest.py:48)

INFO:backend.backend_tests.features.conftest:Redis mock initialized for feature test
..\..\..\backend_tests\features\test_agents\test_agent_factory.py::test_create_agent_with_custom_config 
[1m------------------------------- live log setup --------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Redis mock initialized for feature test (conftest.py:43)
C:\Program Files\Python311\Lib\tokenize.py:317: RuntimeWarning: coroutine 'get_mock_redis_service' was never awaited
  filename = readline.__self__.name
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
INFO:core.agents.market_analyst_agent:Setting up MarketAnalystAgent
[1m-------------------------------- live log call --------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Setting up MarketAnalystAgent (market_analyst_agent.py:41)
INFO:backend.backend_tests.features.conftest:Redis mock cleaned up after feature test
[32mPASSED[0m
[1m------------------------------ live log teardown ------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Redis mock cleaned up after feature test (conftest.py:48)

INFO:backend.backend_tests.features.conftest:Redis mock initialized for feature test
..\..\..\backend_tests\features\test_agents\test_agent_factory.py::test_agent_process_message 
[1m------------------------------- live log setup --------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Redis mock initialized for feature test (conftest.py:43)
INFO:core.agents.market_analyst_agent:Setting up MarketAnalystAgent
[1m-------------------------------- live log call --------------------------------[0m
2025-03-05 00:28:07 [[32m    INFO[0m] Setting up MarketAnalystAgent (market_analyst_agent.py:41)
INFO:httpx:HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-03-05 00:28:08 [[32m    INFO[0m] HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1786)
2025-03-05 00:28:38,152 - core.agents.utils.llm_manager - ERROR - Error with provider LLMProvider.DEEPSEEK: DeepSeek API HTTP error: 
ERROR:core.agents.utils.llm_manager:Error with provider LLMProvider.DEEPSEEK: DeepSeek API HTTP error: 
2025-03-05 00:28:38 [[31m[1m   ERROR[0m] Error with provider LLMProvider.DEEPSEEK: DeepSeek API HTTP error:  (llm_manager.py:108)
ERROR:core.agents.market_analyst_agent:Error processing message: Provider LLMProvider.DEEPSEEK failed: DeepSeek API HTTP error: 
2025-03-05 00:28:38 [[31m[1m   ERROR[0m] Error processing message: Provider LLMProvider.DEEPSEEK failed: DeepSeek API HTTP error:  (market_analyst_agent.py:122)
INFO:backend.backend_tests.features.conftest:Redis mock cleaned up after feature test
[31mFAILED[0m
[1m------------------------------ live log teardown ------------------------------[0m
2025-03-05 00:28:38 [[32m    INFO[0m] Redis mock cleaned up after feature test (conftest.py:48)


================================== FAILURES ===================================
[31m[1m_________________________ test_agent_process_message __________________________[0m
[1m[31m..\..\..\backend_tests\features\test_agents\test_agent_factory.py[0m:179: in test_agent_process_message
    [94massert[39;49;00m [33m"[39;49;00m[33mAgent response text[39;49;00m[33m"[39;49;00m [95min[39;49;00m response.content[90m[39;49;00m
[1m[31mE   AssertionError: assert 'Agent response text' in 'I apologize, but I encountered an error: Provider LLMProvider.DEEPSEEK failed: DeepSeek API HTTP error: '[0m
[1m[31mE    +  where 'I apologize, but I encountered an error: Provider LLMProvider.DEEPSEEK failed: DeepSeek API HTTP error: ' = <core.agents.market_analyst_agent.MarketAnalystAgent.AgentResponse object at 0x0000024459749B10>.content[0m
        agent      = <core.agents.market_analyst_agent.MarketAnalystAgent object at 0x00000244596D5250>
        factory    = <core.agents.agent_factory.AgentFactory object at 0x00000244596F2B90>
        mock_env_vars = None
        mock_llm_service = <AsyncMock spec='LLMService' id='2492581489296'>
        response   = <core.agents.market_analyst_agent.MarketAnalystAgent.AgentResponse object at 0x0000024459749B10>
        sample_agent_context = <core.agents.agent_context.AgentContext object at 0x00000244596F0690>
        user_message = "What's your analysis of the current Bitcoin market?"
----------------------------- Captured log setup ------------------------------
[32mINFO    [0m backend.backend_tests.features.conftest:conftest.py:43 Redis mock initialized for feature test
------------------------------ Captured log call ------------------------------
[32mINFO    [0m core.agents.market_analyst_agent:market_analyst_agent.py:41 Setting up MarketAnalystAgent
[32mINFO    [0m httpx:_client.py:1786 HTTP Request: POST https://api.deepseek.com/v1/chat/completions "HTTP/1.1 200 OK"
[31m[1mERROR   [0m core.agents.utils.llm_manager:llm_manager.py:108 Error with provider LLMProvider.DEEPSEEK: DeepSeek API HTTP error: 
[31m[1mERROR   [0m core.agents.market_analyst_agent:market_analyst_agent.py:122 Error processing message: Provider LLMProvider.DEEPSEEK failed: DeepSeek API HTTP error:
---------------------------- Captured log teardown ----------------------------
[32mINFO    [0m backend.backend_tests.features.conftest:conftest.py:48 Redis mock cleaned up after feature test
============================ slowest 10 durations =============================
30.40s call     backend_tests/features/test_agents/test_agent_factory.py::test_agent_process_message
0.17s setup    backend_tests/features/test_agents/test_agent_factory.py::test_agent_factory_initialization
0.04s call     backend_tests/features/test_agents/test_agent_factory.py::test_create_agent
0.03s setup    backend_tests/features/test_agents/test_agent_factory.py::test_create_agent_with_custom_config
0.01s call     backend_tests/features/test_agents/test_agent_factory.py::test_create_agent_with_custom_config
0.01s setup    backend_tests/features/test_agents/test_agent_factory.py::test_get_agent_factory
0.01s setup    backend_tests/features/test_agents/test_agent_factory.py::test_create_agent
0.01s teardown backend_tests/features/test_agents/test_agent_factory.py::test_agent_factory_initialization
0.00s setup    backend_tests/features/test_agents/test_agent_factory.py::test_agent_process_message
0.00s teardown backend_tests/features/test_agents/test_agent_factory.py::test_get_agent_factory
- Generated html report: file:///C:/Active%20Projects/AI%20AGENTIC%20DEALS%20SYSTEM/backend/scripts/test_results/Feature_report.html -
[36m[1m=========================== short test summary info ===========================[0m
[31mFAILED[0m ..\..\..\backend_tests\features\test_agents\test_agent_factory.py::[1mtest_agent_process_message[0m - AssertionError: assert 'Agent response text' in 'I apologize, but I encount...
[31m!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!![0m
[31m================ [31m[1m1 failed[0m, [32m4 passed[0m, [33m296 deselected[0m[31m in 32.68s[0m[31m =================[0m
pytest-xprocess reminder::Be sure to terminate the started process by running 'pytest --xkill' if you have not explicitly done so in your fixture with 'xprocess.getinfo(<process_name>).terminate()'.
Finished tests at 2025-03-05 00:28:38.927943
Duration: 40.80 seconds
Exit code: 1
C:\Users\GLuK Laptop\AppData\Local\Temp\tmpialljs.tmp.py:111: RuntimeWarning: coroutine 'get_mock_redis_service' was never awaited
  gc.collect()
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
